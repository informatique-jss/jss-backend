<ng-template #accordionTools>
  <mat-panel-description>
    <mat-icon matTooltip="Ouvrir tous les onglets" (click)="accordion!.openAll();$event.stopPropagation();"
      class="pointer">
      unfold_more_double</mat-icon>
    <mat-icon matTooltip="Fermer tous les autres onglets" (click)="accordion!.closeAll();" class="pointer">
      unfold_less_double</mat-icon>
  </mat-panel-description>
</ng-template>
<div [hidden]="!editMode && (quotation.id==undefined || quotation.id==null)">
  <mat-tab-group animationDuration="0ms" #tabs>
    <mat-tab label="Donneur d'ordre">
      <ordering-customer [quotation]="quotation" [editMode]="editMode">
      </ordering-customer>
    </mat-tab>
    <mat-tab label="Prestations">
      <div class="mat-elevation-z2 form-div">
        <div class="row-field-container">
          <mat-form-field class="full-width">
            <input matInput (keyup)="applyFilter($event.target)" placeholder="Rechercher une prestation">
          </mat-form-field>
          <button *ngIf="editMode" (click)="createProvision()" mat-mini-fab color="warn"
            matTooltip="Ajouter une prestation" class="mini-fab-add">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <mat-accordion multi>
          <mat-expansion-panel *ngFor="let provision of filteredProvisions; let index = index;">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span *ngIf="provision.affaire">Affaire <span *ngIf="!provision.affaire.isIndividual && provision.affaire.denomination!=null
                 && provision.affaire.denomination!=undefined">{{provision.affaire.denomination}}</span><span *ngIf="provision.affaire.isIndividual
                 && provision.affaire.firstname!=null
                 && provision.affaire.firstname!=undefined  && provision.affaire.lastname!=null
                 && provision.affaire.lastname!=undefined">{{provision.affaire.firstname}}
                    {{provision.affaire.lastname}}</span><span
                    *ngIf="provision.provisionFamilyType && provision.provisionType"> - Service
                    {{provision.provisionFamilyType.label}}/{{provision.provisionType.label}}</span>
                </span>
              </mat-panel-title>
              <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
              <mat-panel-description>
                <mat-icon *ngIf="editMode" (click)="deleteProvision(index)" class="pointer">
                  delete</mat-icon>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <affaire [(affaire)]="provision.affaire" [editMode]="editMode"></affaire>
            <provision-item *ngIf="provision.affaire && provision.affaire.id" [editMode]="editMode"
              [provision]="provision" [affaire]="provision.affaire">
            </provision-item>
            <button *ngIf="editMode && provision.affaire && provision.affaire.id"
              (click)="createProvisionForAffaire(provision.affaire)" mat-raised-button color="accent">Ajouter une
              prestation pour cette affaire</button>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
    </mat-tab>
    <mat-tab label="ElÃ©ments du devis">
      <quotation-management [quotation]="quotation" [editMode]="editMode"></quotation-management>
    </mat-tab>
    <mat-tab label="Documents" *ngIf="quotation.id!=null && quotation.id!=undefined">
      <attachments [entity]="quotation" [editMode]="editMode" [entityType]="QUOTATION_ENTITY_TYPE.entityType">
      </attachments>
    </mat-tab>
    <mat-tab label="Historique" *ngIf="quotation.id!=null && quotation.id!=undefined">
      <history [entity]="quotation" [entityType]="QUOTATION_ENTITY_TYPE"></history>
    </mat-tab>
  </mat-tab-group>
</div>
<button matTooltip="Sauvegarder" mat-fab color="warn" class="fab-button" *ngIf="editMode==true"
  (click)="saveQuotation()">
  <mat-icon>save</mat-icon>
</button>
<button matTooltip="Modifier le devis" mat-fab color="accent" class="fab-button"
  *ngIf="editMode==false && quotation.id!=undefined && quotation.id!=null" (click)="editQuotation()">
  <mat-icon>edit</mat-icon>
</button>
<button matTooltip="Ajouter un devis" mat-fab color="accent" class="fab-button"
  *ngIf="editMode==false && (quotation.id==undefined || quotation.id==null)" (click)="createQuotation()">
  <mat-icon>add</mat-icon>
</button>
<button matTooltip="Rechercher un devis" mat-fab color="accent" class="second-fab-button" *ngIf="editMode==false"
  (click)="openSearch()">
  <mat-icon>search</mat-icon>
</button>
<button matTooltip="Envoyer le devis" mat-fab color="accent" class="third-fab-button"
  *ngIf="editMode==false  && quotation.id!=undefined && quotation.id!=null" (click)="sendQuotation()">
  <mat-icon>forward_to_inbox</mat-icon>
</button>
<button matTooltip="Valider le statut" mat-fab color="accent" class="fourth-fab-button"
  *ngIf="editMode==false  && quotation.id!=undefined && quotation.id!=null" (click)="confirmStatus()">
  <mat-icon>done</mat-icon>
</button>
<button matTooltip="Ajouter un devis" mat-fab color="accent" class="second-fab-button"
  *ngIf="editMode==false && quotation.id!=undefined && quotation.id!=null" (click)=" createQuotation()">
  <mat-icon>add</mat-icon>
</button>
