<ng-template #accordionTools>
  <mat-panel-description>
    <mat-icon matTooltip="Ouvrir tous les onglets" (click)="accordion!.openAll();$event.stopPropagation();"
      class="pointer">
      unfold_more_double</mat-icon>
    <mat-icon matTooltip="Fermer tous les autres onglets" (click)="accordion!.closeAll();" class="pointer">
      unfold_less_double</mat-icon>
  </mat-panel-description>
</ng-template>

<mat-sidenav-container class="sidenav-container">
  <mat-sidenav #sidenav mode="side" position="end" [fixedInViewport]="true" [fixedTopGap]="165" [fixedBottomGap]="100">
    <ng-container *ngIf="quotation && quotation.assoAffaireOrders">
      <div *ngFor="let asso of quotation.assoAffaireOrders">
        <td class="affaire" *ngIf="asso.affaire && asso.affaire.denomination">
          {{asso.affaire.denomination}}
        </td>
        <td class="affaire" *ngIf="asso.affaire && asso.affaire.firstname">
          {{asso.affaire.firstname}} - {{asso.affaire.lastname}} -
        </td>
        <div *ngFor="let provision of asso.provisions">
          <div *ngFor="let invoiceItem of provision.invoiceItems;let index = index">
            <table>
              <tr *ngIf="provision.provisionType">
                <td class="affaire">
                  {{provision.provisionType.label}}
                </td>
              </tr>
              <tr>
                <td>
                  {{invoiceItem.label}}
                </td>
                <td class="td-price">
                  {{invoiceItem.preTaxPrice|number}} €
                </td>
              </tr>
              <tr *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0">
                <td>
                  Remise
                </td>
                <td class="td-price remise">
                  - {{invoiceItem.discountAmount|number}} €
                </td>
              </tr>
              <tr *ngIf="invoiceItem.vat">
                <td>
                  {{invoiceItem.vat.label}}
                </td>
                <td class="td-price">
                  {{invoiceItem.vatPrice|number}} €
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <table class="total-table">
        <tr>
          <td>
            Prix total HT
          </td>
          <td class="td-price">
            {{getPreTaxPriceTotal() |number}} €
          </td>
        </tr>
        <tr *ngIf="getDiscountTotal() && getDiscountTotal()>0">
          <td>
            Remise totale
          </td>
          <td class="td-price remise">
            - {{getDiscountTotal()|number}} €
          </td>
        </tr>
        <tr>
          <td>
            Total HT
          </td>
          <td class="td-price">
            {{getPreTaxPriceTotal()-getDiscountTotal()|number}} €
          </td>
        </tr>
        <tr *ngIf="getApplicableVat()!=undefined">
          <td>
            Total {{getApplicableVat()!.label}}
          </td>
          <td class="td-price">
            {{getVatTotal()|number}} €
          </td>
        </tr>
        <tr>
          <td>
            Total TTC
          </td>
          <td class="td-price">
            {{getPriceTotal()|number}} €
          </td>
        </tr>
        <ng-container *ngIf="instanceOfCustomerOrderFn(quotation) && quotation.deposits">
          <ng-container *ngFor="let deposit of quotation.deposits">
            <tr>
              <td>
                Accompte n°{{deposit.id}}
              </td>
              <td class="td-price">
                {{deposit.depositAmount|number}} €
              </td>
            </tr>
          </ng-container>
          <tr>
            <td>Reste à payer</td>
            <td class="td-price">{{getRemainingToPay()}} €</td>
          </tr>
        </ng-container>
      </table>
    </ng-container>
  </mat-sidenav>

  <mat-sidenav-content>
    <div *ngIf="!editMode && !quotation.id && !isQuotationUrl && !idQuotation">
      <ordering-list></ordering-list>
    </div>
    <div *ngIf="!editMode && !quotation.id && isQuotationUrl && !idQuotation">
      <quotation-list></quotation-list>
    </div>
    <div [hidden]="!editMode && (quotation.id==undefined || quotation.id==null)">
      <fieldset [disabled]="editMode==false" class="fieldset-no-border">
        <mat-tab-group animationDuration="0ms" #tabs [(selectedIndex)]="selectedTabIndex"
          (selectedTabChange)="changeTab($event)">
          <mat-tab label="Donneur d'ordre">
            <ordering-customer [quotation]="quotation" [editMode]="editMode" (updateDocuments)="updateDocuments()">
            </ordering-customer>
          </mat-tab>
          <mat-tab label="Prestations" *ngIf="(quotation.tiers || quotation.responsable || quotation.confrere)  ">
            <div class="mat-elevation-z2 form-div" *ngIf="quotation.assoAffaireOrders">
              <mat-tab-group animationDuration="0ms" #tabs>
                <mat-tab *ngFor="let asso of quotation.assoAffaireOrders" [label]="asso.affaire.denomination?asso.affaire.denomination:(asso.affaire.firstname + ' ' +
                asso.affaire.lastname)">
                  <div class="mat-accordion-container full-width">
                    <mat-accordion multi>
                      <mat-expansion-panel expanded="false">
                        <mat-expansion-panel-header>
                          <mat-panel-title>Détails de l'affaire
                            {{asso.affaire.denomination?asso.affaire.denomination:(asso.affaire.firstname + ' '
                            +asso.affaire.lastname)}} - {{asso.affaire.address}} - {{asso.affaire.postalCode}} -
                            {{asso.affaire.country.label}}
                          </mat-panel-title>
                          <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
                        </mat-expansion-panel-header>
                        <add-affaire [affaire]="asso.affaire" [editMode]="false"></add-affaire>
                        <div *ngIf="asso && asso.id && instanceOfCustomerOrder">
                          <autocomplete-employee [(model)]="asso.assignedTo" [form]="quotationForm"
                            propertyName="assignedTo" [isMandatory]="true" [isDisabled]="false"
                            label="Affaire assignée à" (onOptionSelected)="updateAssignedToForAffaire($event,asso)">
                          </autocomplete-employee>
                        </div>
                      </mat-expansion-panel>
                    </mat-accordion>
                  </div>
                  <div class="mat-accordion-container full-width">
                    <mat-accordion multi class="mat-accordion-container">
                      <mat-expansion-panel *ngFor="let provision of asso.provisions" [expanded]="!provision.id">
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            {{provision.provisionType ? (provision.provisionFamilyType.label +' -
                            '+provision.provisionType.label):''}}
                          </mat-panel-title>
                          <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
                          <mat-panel-description *ngIf="editMode">
                            <mat-icon matTooltip="Supprimer la prestation" (click)="deleteProvision(asso,provision)"
                              class="pointer">
                              delete</mat-icon>
                          </mat-panel-description>
                        </mat-expansion-panel-header>
                        <provision-item *ngIf="asso.affaire && asso.affaire.id" [editMode]="editMode"
                          [provision]="provision" [affaire]="asso.affaire"
                          (selectedProvisionTypeChange)="changeSelectedProvisionType($event)"
                          [instanceOfCustomerOrder]="instanceOfCustomerOrder" [isStatusOpen]="isStatusOpen">
                        </provision-item>
                      </mat-expansion-panel>
                    </mat-accordion>
                  </div>
                  <div class="row-field-container">
                    <button mat-raised-button *ngIf="editMode" (click)="createProvision(asso)" color="primary"
                      class="mini-fab-add">
                      Ajouter une prestation pour
                      {{asso.affaire.denomination?asso.affaire.denomination:(asso.affaire.firstname + '
                      '+asso.affaire.lastname)}}
                    </button>
                  </div>
                </mat-tab>
              </mat-tab-group>
            </div>
          </mat-tab>
          <mat-tab label="Facturation" *ngIf="quotation && quotation.id">
            <invoice-management [quotation]=" quotation" [editMode]="editMode"
              (invoiceItemChange)="invoiceItemChange($event)" [instanceOfCustomerOrder]="instanceOfCustomerOrder">
            </invoice-management>
          </mat-tab>
          <mat-tab [label]="'Eléments '+(instanceOfCustomerOrder ? 'de la commande' : 'du devis')">
            <quotation-management [quotation]="quotation" [editMode]="editMode"
              [updateDocumentsEvent]="updateDocumentsEvent.asObservable()"></quotation-management>
          </mat-tab>
          <mat-tab label="Documents" *ngIf="quotation.id!=null && quotation.id!=undefined">
            <attachments [entity]="quotation" [editMode]="editMode" [entityType]="getEntityType().entityType">
            </attachments>
          </mat-tab>
          <mat-tab label="Historique du statut" *ngIf="quotation.id!=null && quotation.id!=undefined">
            <history [entity]="quotation" [entityType]="getEntityType()" [displayOnlyFields]="['status']"
              [parseTypeList]="quotationStatusList"></history>
          </mat-tab>
          <mat-tab label="Historique" *ngIf="quotation.id!=null && quotation.id!=undefined">
            <history [entity]="quotation" [entityType]="getEntityType()"></history>
          </mat-tab>
        </mat-tab-group>
      </fieldset>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
<button matTooltip="Sauvegarder" mat-fab color="warn" class="fab-button" *ngIf="editMode==true"
  (click)="saveQuotation()">
  <mat-icon>save</mat-icon>
</button>
<button matTooltip="Ajouter une affaire / prestation" mat-fab color="accent" class="third-fab-button"
  *ngIf="editMode  &&  (quotation.tiers || quotation.responsable || quotation.confrere) " (click)="addAffaire()">
  <mat-icon>person_add</mat-icon>
</button>
<button [matTooltip]="instanceOfCustomerOrder?'Modifier la commande' : 'Modifier le devis'" mat-fab color="accent"
  class="fab-button" *ngIf="editMode==false && quotation.id!=undefined && quotation.id!=null" (click)="editQuotation()">
  <mat-icon>edit</mat-icon>
</button>
<button [matTooltip]="instanceOfCustomerOrder?'Ajouter une commande' : 'Ajouter un devis'" mat-fab color="accent"
  class="fab-button" *ngIf="editMode==false && (quotation.id==undefined || quotation.id==null)"
  (click)="createQuotation()">
  <mat-icon>add</mat-icon>
</button>
<button [matTooltip]="instanceOfCustomerOrder?'Rechercher une commande' : 'Rechercher un devis'" mat-fab color="accent"
  class="second-fab-button" *ngIf="editMode==false" (click)="openSearch()">
  <mat-icon>search</mat-icon>
</button>
<button [matTooltip]="instanceOfCustomerOrder?'Envoyer la commande' : 'Envoyer le devis'" mat-fab color="accent"
  class="third-fab-button" *ngIf="editMode==false  && quotation.id!=undefined && quotation.id!=null"
  (click)="sendQuotation()">
  <mat-icon>forward_to_inbox</mat-icon>
</button>
<button [matTooltip]="instanceOfCustomerOrder?'Ajouter une commande' : 'Ajouter un devis'" mat-fab color="accent"
  class="second-fab-button" *ngIf="editMode==false && quotation.id!=undefined && quotation.id!=null"
  (click)=" createQuotation()">
  <mat-icon>add</mat-icon>
</button>
<button [matTooltip]='sidenav.opened?"Cacher le détail":"Voir le détail"' mat-fab color="accent"
  [ngClass]="{'fifth-fab-button':editMode==false,'second-fab-button':editMode==true}"
  *ngIf="(editMode==false && quotation.id!=undefined && quotation.id!=null || editMode)" (click)=" sidenav.toggle()">
  <mat-icon>receipt_long</mat-icon>
</button>

<button matTooltip="Changer de statut" mat-fab color="accent" class="fourth-fab-button"
  *ngIf="editMode==false && instanceOfQuotationFn(this.quotation) &&quotation && quotation.quotationStatus && (quotation.quotationStatus.successors || quotation.quotationStatus.predecessors)"
  [matMenuTriggerFor]="menu">
  <mat-icon>done</mat-icon>
  <mat-menu #menu="matMenu" style="min-height: 0px;padding: 0;" xPosition="before">
    <button mat-menu-item (click)="displayQuotationWorkflowDialog()">
      <span>Voir le workflow</span>
    </button>
    <button disabled mat-menu-item *ngIf="quotation.quotationStatus.successors">
      <span>Passer à</span>
    </button>
    <button mat-menu-item *ngFor="let status of quotation.quotationStatus.successors" (click)="changeStatus(status)">
      <mat-icon>{{status.icon}}</mat-icon><span>{{status.label}}</span>
    </button>
    <button disabled mat-menu-item
      *ngIf="quotation.quotationStatus.predecessors && quotation.quotationStatus.predecessors.length>0">
      <span>Revenir à</span>
    </button>
    <button mat-menu-item *ngFor="let status of quotation.quotationStatus.predecessors" (click)="changeStatus(status)">
      <mat-icon>{{status.icon}}</mat-icon><span>{{status.label}}</span>
    </button>
  </mat-menu>
</button>


<button matTooltip="Changer de statut" mat-fab color="accent" class="fourth-fab-button"
  *ngIf="editMode==false && instanceOfCustomerOrderFn(this.quotation) &&quotation && quotation.customerOrderStatus && (quotation.customerOrderStatus.successors || quotation.customerOrderStatus.predecessors)"
  [matMenuTriggerFor]="menu">
  <mat-icon>done</mat-icon>
  <mat-menu #menu="matMenu" style="min-height: 0px;padding: 0;" xPosition="before">
    <button mat-menu-item (click)="displayCustomerOrderWorkflowDialog()">
      <span>Voir le workflow</span>
    </button>
    <button disabled mat-menu-item *ngIf="quotation.customerOrderStatus.successors">
      <span>Passer à</span>
    </button>
    <button mat-menu-item *ngFor="let status of quotation.customerOrderStatus.successors"
      (click)="changeStatus(status)">
      <mat-icon>{{status.icon}}</mat-icon><span>{{status.label}}</span>
    </button>
    <button disabled mat-menu-item
      *ngIf="quotation.customerOrderStatus.predecessors && quotation.customerOrderStatus.predecessors.length>0">
      <span>Revenir à</span>
    </button>
    <button mat-menu-item *ngFor="let status of quotation.customerOrderStatus.predecessors"
      (click)="changeStatus(status)">
      <mat-icon>{{status.icon}}</mat-icon><span>{{status.label}}</span>
    </button>
  </mat-menu>
</button>
