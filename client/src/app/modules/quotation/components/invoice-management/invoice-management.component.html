<div *ngIf="quotation && quotation.id" class=" form-div min-height ">
  <ng-container *ngIf="instanceOfCustomerOrderFn(quotation) &&  quotation.invoices">
    <h3 class="invoice-title" *ngFor="let invoice of quotation.invoices">
      Facture n°{{invoice.id}} émise à Paris, le {{invoice.createdDate|date:'dd/MM/yyyy à HH:mm'}}<span
        *ngIf="getLetteringDate(invoice)">,
        lettrée le {{getLetteringDate(invoice)|date:'dd/MM/yyyy à HH:mm'}}</span>
      <chips-status class="invoice-chip" [status]="invoice.invoiceStatus.code" [value]="invoice.invoiceStatus.label">
      </chips-status>
      <mat-icon (click)="openRoute($event,'/invoicing/view/'+invoice.id)"
        (auxclick)="openRoute($event,'/invoicing/view/'+invoice.id)" matTooltip="Voir la facture" color="accent"
        class="pointer invoice-chip">visibility
      </mat-icon>
    </h3>
  </ng-container>
  <fieldset [disabled]="editMode==false" class="fieldset-no-border">
    <table class="full-width mat-table description-table ">
      <tr class=" mat-header-row">
        <th class="mat-header-cell">Affaire(s)</th>
        <th class="mat-header-cell">Payeur</th>
        <th class="mat-header-cell">Donneur d'ordre</th>
      </tr>
      <tr class=" mat-row">
        <td class="mat-cell td-info">
          <p>{{getAffaireListFromIQuotation(quotation)}}</p>
        </td>
        <td class="mat-cell td-info">
          <ng-container *ngIf="invoiceLabelResult">
            <p [ngClass]="{'color-warn':!invoiceLabelResult.billingLabel}">
              {{invoiceLabelResult.billingLabel?invoiceLabelResult.billingLabel:"Libellé inconnu"}}</p>
            <p [ngClass]="{'color-warn':!invoiceLabelResult.billingLabelAddress}">
              {{invoiceLabelResult.billingLabelAddress?invoiceLabelResult.billingLabelAddress:"Adresse"}}</p>
            <p
              [ngClass]="{'color-warn':!invoiceLabelResult.billingLabelPostalCode || !invoiceLabelResult.billingLabelCity || !invoiceLabelResult.billingLabelCountry}">
              {{invoiceLabelResult.billingLabelPostalCode?invoiceLabelResult.billingLabelPostalCode:"Code
              postal inconnu"}}
              {{invoiceLabelResult.billingLabelCity?invoiceLabelResult.billingLabelCity.label:"Ville inconnue"}}
              {{invoiceLabelResult.billingLabelCountry?invoiceLabelResult.billingLabelCountry.label:"Pays
              inconnu"}}
            </p>
          </ng-container>
        </td>
        <td class="mat-cell td-info">
          <p>{{getCustomerOrderNameForIQuotation(quotation)}}</p>
          <p>{{getCustomerOrderForIQuotation(quotation).address}}</p>
          <p>{{getCustomerOrderForIQuotation(quotation).postalCode}}
            {{getCustomerOrderForIQuotation(quotation).city?getCustomerOrderForIQuotation(quotation).city.label:""}}{{getCustomerOrderForIQuotation(quotation).country?getCustomerOrderForIQuotation(quotation).country.label:""}}
          </p>
        </td>
      </tr>
    </table>
    <form [formGroup]="invoiceManagementForm">
      <table class="full-width container-affaire mat-table">
        <tr class=" mat-header-row">
          <th class="mat-header-cell" colspan="2">Facture</th>
        </tr>
        <ng-container *ngFor="let asso of quotation.assoAffaireOrders;let indexAsso = index">
          <tr class="mat-row">
            <td class="affaire mat-cell" colspan="2" *ngIf="asso.affaire && asso.affaire.denomination">
              {{asso.affaire.denomination}}
            </td>
            <td class="affaire mat-cell" colspan="2" *ngIf="asso.affaire && asso.affaire.firstname">
              {{asso.affaire.firstname}} - {{asso.affaire.lastname}} -
            </td>
          </tr>
          <ng-container *ngFor="let provision of asso.provisions;let indexProvision = index">
            <tr class="mat-row" *ngIf="provision.provisionType">
              <td class="affaire mat-cell" colspan="2">
                {{provision.provisionType.label}}
              </td>
            </tr>
            <ng-container *ngFor="let invoiceItem of provision.invoiceItems;let indexInvoiceItem = index">
              <tr class="mat-row">
                <td class="mat-cell">
                  {{invoiceItem.label}} <mat-icon inline="true"
                    [matTooltip]="invoiceItem.isGifted?'Ne plus offrir cette ligne de facturation':'Offrir cette ligne de facturation'"
                    *ngIf="editMode && !getLetteringDate(invoiceItem.invoice)" class="info-icon pointer"
                    (click)="toggleIsGifTed(invoiceItem)">redeem</mat-icon>
                  <mat-icon inline="true" matTooltip="Veuillez enregistrer pour pouvoir modifier le prix appliqué"
                    *ngIf="editMode && invoiceItem.billingItem.billingType.canOverridePrice==true && !invoiceItem.id && !invoiceItem.invoice"
                    class="info-icon">info</mat-icon>
                </td>
                <td class="td-price mat-cell"
                  *ngIf="!editMode || invoiceItem.billingItem.billingType.canOverridePrice==false || !invoiceItem.id || invoiceItem.invoice">
                  {{invoiceItem.preTaxPrice|number}} €
                </td>
                <td class="mat-cell"
                  *ngIf="editMode && invoiceItem.billingItem.billingType.canOverridePrice==true && invoiceItem.id && !invoiceItem.invoice">
                  <generic-input [(model)]="invoiceItem.preTaxPrice" label="" [form]="invoiceManagementForm"
                    [propertyName]='"preTaxPrice"+indexInvoiceItem+indexProvision+indexAsso' [isMandatory]="true"
                    type="number" step="0,01" (onInputChange)="itemChange(invoiceItem)"
                    hint="Laisser vide pour recalculer le prix">
                  </generic-input>
                </td>
              </tr>
              <tr class="mat-row" *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0">
                <td class="mat-cell">
                  Remise
                </td>
                <td class="td-price remise mat-cell">
                  - {{invoiceItem.discountAmount|number}} €
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </ng-container>
      </table>
    </form>
    <table class="total-table mat-table full-width">
      <tr class=" mat-header-row">
        <th class="mat-header-cell" colspan="2">Total</th>
      </tr>
      <tr class="mat-row">
        <td class="mat-cell">
          Prix total HT
        </td>
        <td class="td-price mat-cell">
          {{getPreTaxPriceTotal() |number}} €
        </td>
      </tr>
      <tr class="mat-row" *ngIf="getDiscountTotal() && getDiscountTotal()>0">
        <td class="mat-cell">
          Remise totale
        </td>
        <td class="td-price remise mat-cell">
          - {{getDiscountTotal()|number}} €
        </td>
      </tr>
      <tr class="mat-row" *ngIf="getDiscountTotal() && getDiscountTotal()>0">
        <td class="mat-cell">
          Total HT avec remise
        </td>
        <td class="td-price mat-cell">
          {{getPreTaxPriceTotal()-getDiscountTotal()|number}} €
        </td>
      </tr>
      <ng-container *ngIf="getApplicableVat().length>0">
        <tr *ngFor="let vat of getApplicableVat()">
          <td class="mat-cell">
            Total {{vat.label}} sur la base de {{vat.base |number}} €
          </td>
          <td class="td-price mat-cell">
            {{vat.total|number}} €
          </td>
        </tr>
      </ng-container>
      <tr class="mat-row">
        <td class="mat-cell">
          Total TTC
        </td>
        <td class="td-price mat-cell">
          {{getPriceTotal()|number}} €
        </td>
      </tr>
      <ng-container *ngIf="instanceOfCustomerOrderFn(quotation)">
        <tr class="mat-row" *ngFor="let deposit of quotation.deposits">
          <td class="mat-cell">
            Accompte n°{{deposit.id}}
          </td>
          <td class="td-price mat-cell">
            - {{deposit.depositAmount|number}} €
          </td>
        </tr>
      </ng-container>
      <tr class="mat-row">
        <td class="mat-cell">Reste à payer
        </td>
        <td class="td-price mat-cell">{{getRemainingToPay()}} €
        </td>
      </tr>
      <tr
        *ngIf="quotation && instanceOfCustomerOrderFn(quotation) && quotation.centralPayPendingPaymentAmount  && quotation.centralPayPendingPaymentAmount >0">
        <td class="mat-cell">Paiement reçu par CB en attente de réception</td>
        <td class="td-price mat-cell">{{quotation.centralPayPendingPaymentAmount | number}} €</td>
      </tr>
    </table>
  </fieldset>
</div>
