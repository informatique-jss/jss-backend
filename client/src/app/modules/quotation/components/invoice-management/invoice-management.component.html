<div *ngIf="quotation && quotation.id" class=" form-div min-height ">
  <ng-container *ngIf="instanceOfCustomerOrderFn(quotation) &&  customerOrderInvoices">
    <h3 *ngFor="let invoice of customerOrderInvoices">
      <div class="invoice-title">Facture n°{{invoice.invoiceId}} émise à Paris, le
        {{invoice.createdDate|date:'dd/MM/yyyy à HH:mm'}}<chips-status class="invoice-chip"
          [status]="invoice.invoiceStatusCode" [value]="invoice.invoiceStatus">
        </chips-status>
        <mat-icon color="accent" (click)="openRoute($event,'/invoicing/view/'+invoice.invoiceId)"
          (auxclick)="openRoute($event,'/invoicing/view/'+invoice.invoiceId)" matTooltip="Voir la facture"
          color="accent" class="pointer invoice-chip">visibility
        </mat-icon>
      </div>
    </h3>
  </ng-container>
  <ng-container *ngIf="instanceOfCustomerOrderFn(quotation) &&  customerOrderProviderInvoices">
    <h3 class="invoice-title" *ngFor="let invoice of customerOrderProviderInvoices">
      Facture fournisseur n°{{invoice.invoiceId}}, {{invoice.providerLabel}}, saisie le
      {{invoice.createdDate|date:'dd/MM/yyyy à HH:mm'}}, pour un
      total
      de {{invoice.totalPrice}} €
      <chips-status class="invoice-chip" [status]="invoice.invoiceStatusCode" [value]="invoice.invoiceStatus">
      </chips-status>
      <mat-icon color="accent" (click)="openRoute($event,'/invoicing/view/'+invoice.invoiceId)"
        (auxclick)="openRoute($event,'/invoicing/view/'+invoice.invoiceId)" matTooltip="Voir la facture" color="accent"
        class="pointer invoice-chip">visibility
      </mat-icon>
    </h3>
  </ng-container>
  <fieldset [disabled]="editMode==false" class="fieldset-no-border">
    <table class="mat-table mat-mdc-table mdc-data-table__table full-width  description-table ">
      <thead>
        <tr class="mat-mdc-header-row mdc-data-table__header-row ">
          <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Affaire(s)</th>
          <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Payeur</th>
          <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Donneur d'ordre</th>
        </tr>
      </thead>
      <tr class="mat-mdc-row mdc-data-table__row ">
        <td class="mat-mdc-cell mdc-data-table__cell  td-info">
          <p>{{getAffaireListFromIQuotation(quotation)}}</p>
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-info">
          <ng-container *ngIf="invoiceLabelResult">
            <p [ngClass]="{'color-warn':!invoiceLabelResult.billingLabel}">
              {{invoiceLabelResult.billingLabel?invoiceLabelResult.billingLabel:"Libellé inconnu"}}</p>
            <p [ngClass]="{'color-warn':!invoiceLabelResult.billingLabelAddress}">
              {{invoiceLabelResult.billingLabelAddress?invoiceLabelResult.billingLabelAddress:"Adresse"}}</p>
            <p
              [ngClass]="{'color-warn':!invoiceLabelResult.billingLabelPostalCode || !invoiceLabelResult.billingLabelCity || !invoiceLabelResult.billingLabelCountry}">
              {{invoiceLabelResult.billingLabelPostalCode?invoiceLabelResult.billingLabelPostalCode:"Code
              postal inconnu"}}
              {{invoiceLabelResult.billingLabelCity?invoiceLabelResult.billingLabelCity.label:"Ville inconnue"}}
              {{invoiceLabelResult.billingLabelCountry?invoiceLabelResult.billingLabelCountry.label:"Pays
              inconnu"}}
            </p>
            <p *ngIf="invoiceLabelResult.billingLabelIntercommunityVat">N° de TVA :
              {{invoiceLabelResult.billingLabelIntercommunityVat}}</p>
          </ng-container>
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-info">
          <p>{{getCustomerOrderNameForIQuotation(quotation)}}</p>
          <p>{{getCustomerOrderForIQuotation(quotation).address}}</p>
          <p>{{getCustomerOrderForIQuotation(quotation).postalCode}}
            {{getCustomerOrderForIQuotation(quotation).city?getCustomerOrderForIQuotation(quotation).city.label:""}}{{getCustomerOrderForIQuotation(quotation).country?getCustomerOrderForIQuotation(quotation).country.label:""}}
          </p>
        </td>
      </tr>
    </table>
    <form [formGroup]="invoiceManagementForm">
      <table class="mat-table mat-mdc-table mdc-data-table__table full-width container-affaire ">
        <thead>
          <tr class="mat-mdc-header-row mdc-data-table__header-row ">
            <th class="mat-mdc-header-cell mdc-data-table__header-cell " colspan="2">Facture</th>
          </tr>
        </thead>
        <ng-container *ngFor="let asso of quotation.assoAffaireOrders;let indexAsso = index">
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell  affaire " colspan="2"
              *ngIf="asso.affaire && asso.affaire.denomination">
              {{asso.affaire.denomination}}
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  affaire " colspan="2"
              *ngIf="asso.affaire && asso.affaire.firstname">
              {{asso.affaire.firstname}} - {{asso.affaire.lastname}} -
            </td>
          </tr>
          <ng-container *ngFor="let provision of asso.provisions;let indexProvision = index">
            <tr class="mat-mdc-row mdc-data-table__row " *ngIf="provision.provisionType">
              <td class="mat-mdc-cell mdc-data-table__cell  affaire " colspan="2">
                {{provision.provisionType.label}}
              </td>
            </tr>
            <ng-container *ngFor="let invoiceItem of provision.invoiceItems;let indexInvoiceItem = index">
              <tr class="mat-mdc-row mdc-data-table__row ">
                <td class="mat-mdc-cell mdc-data-table__cell ">
                  {{invoiceItem.label}} <mat-icon color="accent" inline="true"
                    [matTooltip]="invoiceItem.isGifted?'Ne plus offrir cette ligne de facturation':'Offrir cette ligne de facturation'"
                    *ngIf="editMode && !getLetteringDate(invoiceItem.invoice)" class="info-icon pointer"
                    (click)="toggleIsGifTed(invoiceItem)">redeem</mat-icon>
                  <mat-icon color="accent" inline="true"
                    matTooltip="Veuillez enregistrer pour pouvoir modifier le prix appliqué"
                    *ngIf="editMode && invoiceItem.billingItem.billingType.canOverridePrice==true && !invoiceItem.id && !invoiceItem.invoice"
                    class="info-icon">info</mat-icon>
                </td>
                <td class="mat-mdc-cell mdc-data-table__cell  td-price "
                  *ngIf="!editMode || invoiceItem.billingItem.billingType.canOverridePrice==false || !invoiceItem.id || invoiceItem.invoice">
                  {{invoiceItem.preTaxPrice|number}} €
                </td>
                <td class="mat-mdc-cell mdc-data-table__cell "
                  *ngIf="editMode && invoiceItem.billingItem.billingType.canOverridePrice==true && invoiceItem.id && !invoiceItem.invoice">
                  <generic-input [(model)]="invoiceItem.preTaxPrice" label="" [form]="invoiceManagementForm"
                    [propertyName]='"preTaxPrice"+indexInvoiceItem+indexProvision+indexAsso' [isMandatory]="true"
                    type="number" step="0,01" (onFormBlur)="itemChange(invoiceItem)"
                    hint="Laisser vide pour recalculer le prix">
                  </generic-input>
                </td>
              </tr>
              <tr class="mat-mdc-row mdc-data-table__row "
                *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0">
                <td class="mat-mdc-cell mdc-data-table__cell ">
                  Remise
                </td>
                <td class="mat-mdc-cell mdc-data-table__cell  td-price remise ">
                  - {{invoiceItem.discountAmount|number}} €
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </ng-container>
      </table>
    </form>
    <table class="mat-table mat-mdc-table mdc-data-table__table total-table  full-width">
      <thead>
        <tr class="mat-mdc-header-row mdc-data-table__header-row ">
          <th class="mat-mdc-header-cell mdc-data-table__header-cell " colspan="2">Total</th>
        </tr>
      </thead>
      <tr class="mat-mdc-row mdc-data-table__row ">
        <td class="mat-mdc-cell mdc-data-table__cell ">
          Prix total HT
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
          {{getPreTaxPriceTotal() |number}} €
        </td>
      </tr>
      <tr class="mat-mdc-row mdc-data-table__row " *ngIf="getDiscountTotal() && getDiscountTotal()>0">
        <td class="mat-mdc-cell mdc-data-table__cell ">
          Remise totale
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-price remise ">
          - {{getDiscountTotal()|number}} €
        </td>
      </tr>
      <tr class="mat-mdc-row mdc-data-table__row " *ngIf="getDiscountTotal() && getDiscountTotal()>0">
        <td class="mat-mdc-cell mdc-data-table__cell ">
          Total HT avec remise
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
          {{getPreTaxPriceTotal()-getDiscountTotal()|number}} €
        </td>
      </tr>
      <ng-container *ngIf="getApplicableVat().length>0">
        <tr *ngFor="let vat of getApplicableVat()">
          <td class="mat-mdc-cell mdc-data-table__cell ">
            Total {{vat.label}} sur la base de {{vat.base |number}} €
          </td>
          <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
            {{vat.total|number}} €
          </td>
        </tr>
      </ng-container>
      <tr class="mat-mdc-row mdc-data-table__row ">
        <td class="mat-mdc-cell mdc-data-table__cell ">
          Total TTC
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
          {{getPriceTotal()|number}} €
        </td>
      </tr>
      <ng-container *ngIf="instanceOfCustomerOrderFn(quotation) && getCurrentInvoiceForCustomerOrder()==undefined">
        <tr class="mat-mdc-row mdc-data-table__row " *ngFor="let deposit of quotation.deposits">
          <td class="mat-mdc-cell mdc-data-table__cell  payment-label" [matTooltip]="deposit.originPayment.label">
            Acompte n°{{deposit.id}} - {{deposit.label}} - montant du paiement :
            {{deposit.originPayment.paymentAmount}}
            € - {{deposit.originPayment.label}}
          </td>
          <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
            - {{deposit.depositAmount|number}} €
          </td>
        </tr>
      </ng-container>
      <ng-container *ngIf="instanceOfCustomerOrderFn(quotation) && getCurrentInvoiceForCustomerOrder()!=undefined">
        <tr class="mat-mdc-row mdc-data-table__row " *ngFor="let deposit of quotation.deposits">
          <td class="mat-mdc-cell mdc-data-table__cell  payment-label" [matTooltip]="deposit.originPayment.label">
            Acompte n°{{deposit.id}} - {{deposit.label}} - montant du paiement :
            {{deposit.originPayment.paymentAmount}}
            € - {{deposit.originPayment.label}}
          </td>
          <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
            - {{deposit.depositAmount|number}} €
          </td>
        </tr>
      </ng-container>
      <tr class="mat-mdc-row mdc-data-table__row ">
        <td class="mat-mdc-cell mdc-data-table__cell ">Reste à payer
        </td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-price ">{{getRemainingToPay()}} €
        </td>
      </tr>
      <tr
        *ngIf="quotation && instanceOfCustomerOrderFn(quotation) && quotation.centralPayPendingPaymentAmount  && quotation.centralPayPendingPaymentAmount >0">
        <td class="mat-mdc-cell mdc-data-table__cell ">Paiement reçu par CB en attente de réception</td>
        <td class="mat-mdc-cell mdc-data-table__cell  td-price ">{{quotation.centralPayPendingPaymentAmount | number}} €
        </td>
      </tr>
    </table>
  </fieldset>
</div>