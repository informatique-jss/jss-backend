<div class="mat-elevation-z2 form-div" *ngIf="invoice">
  <mat-tab-group animationDuration="0ms" #tabs>
    <mat-tab label="Détail">
      <div class="full-width top">
        <div class="chips-status">
          <chips-status [status]="invoice.invoiceStatus.code" [value]="invoice.invoiceStatus.label"></chips-status>
        </div>
        <p>Emise à Paris, le {{invoice.createdDate|date:'dd/MM/yyyy à HH:mm'}}<span *ngIf="getLetteringDate(invoice)">,
            lettrée le {{getLetteringDate(invoice)|date:'dd/MM/yyyy à HH:mm'}}</span></p>
        <p *ngIf="invoice.customerOrder">Commande n°{{invoice.customerOrder.id}}
          <mat-icon matTooltip="Voir la commande" color="accent" class="pointer"
            (click)="openRoute($event,'/order/'+invoice.customerOrder.id)"
            (auxclick)="openRoute($event,'/order/'+invoice.customerOrder.id)">visibility
          </mat-icon>
        </p>
        <table class="full-width mat-table description-table ">
          <tr class=" mat-header-row">
            <th class="mat-header-cell">Affaire(s)</th>
            <th class="mat-header-cell">Payeur</th>
            <th class="mat-header-cell">Donneur d'ordre</th>
          </tr>
          <tr class=" mat-row">
            <td class="mat-cell td-info">
              <p>{{getAffaireList(invoice)}}</p>
            </td>
            <td class="mat-cell td-info">
              <p>{{invoice.billingLabel}}</p>
              <p>{{invoice.billingLabelAddress}}</p>
              <p>{{invoice.billingLabelPostalCode}} {{invoice.billingLabelCity.label}}
                {{invoice.billingLabelCountry.label}}</p>
            </td>
            <td class="mat-cell td-info">
              <p>{{getCustomerOrderName(invoice)}}</p>
              <p>{{getCustomerOrder(invoice).address}}</p>
              <p>{{getCustomerOrder(invoice).postalCode}}
                {{getCustomerOrder(invoice).city.label}}{{getCustomerOrder(invoice).country.label}}</p>
            </td>
          </tr>
        </table>
        <table class="full-width container-affaire mat-table" *ngIf="invoice.customerOrder">
          <tr class=" mat-header-row">
            <th class="mat-header-cell" colspan="2">Facture</th>
          </tr>
          <ng-container *ngFor="let asso of invoice.customerOrder.assoAffaireOrders;let indexAsso = index">
            <tr class="mat-row">
              <td class="affaire mat-cell" colspan="2" *ngIf="asso.affaire && asso.affaire.denomination">
                {{asso.affaire.denomination}}
              </td>
              <td class="affaire mat-cell" colspan="2" *ngIf="asso.affaire && asso.affaire.firstname">
                {{asso.affaire.firstname}} - {{asso.affaire.lastname}} -
              </td>
            </tr>
            <ng-container *ngFor="let provision of asso.provisions">
              <tr class="mat-row" *ngIf="provision.provisionType">
                <td class="affaire mat-cell" colspan="2">
                  {{provision.provisionType.label}}
                </td>
              </tr>
              <ng-container *ngFor="let invoiceItem of provision.invoiceItems;let indexInvoiceItem = index">
                <tr class="mat-row">
                  <td class="mat-cell">
                    {{invoiceItem.label}}
                  </td>
                  <td class="td-price mat-cell">
                    {{invoiceItem.preTaxPrice|number}} €
                  </td>
                </tr>
                <tr class="mat-row" *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0">
                  <td class="mat-cell">
                    Remise
                  </td>
                  <td class="td-price remise mat-cell">
                    - {{invoiceItem.discountAmount|number}} €
                  </td>
                </tr>
                <tr class="mat-row" *ngIf="invoiceItem.vat">
                  <td class="mat-cell">
                    {{invoiceItem.vat.label}}
                  </td>
                  <td class="td-price mat-cell">
                    {{invoiceItem.vatPrice|number}} €
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </ng-container>
        </table>
        <ng-container *ngFor="let affaire of getAffaireListArray(invoice)">
          <table class="middle-width container-affaire mat-table" *ngIf="!invoice.customerOrder">
            <ng-container *ngFor="let invoiceItem of invoice.invoiceItems; let index = index">
              <tr class="mat-header-row">
                <th class="mat-header-cell" colspan="2">Affaire {{affaire.denomination}}{{affaire.firstname}}
                  {{affaire.lastname}}
                </th>
              </tr>
              <tr class="mat-row">
                <td class="mat-cell">
                  {{invoiceItem.label}}
                </td>
                <td class="td-price  mat-cell">
                  {{invoiceItem.preTaxPrice|number}} €
                </td>
              </tr>
              <tr *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0" class="mat-row">
                <td class="mat-cell">
                  <div class="sub-row">Remise</div>
                </td>
                <td class="td-price remise mat-cell">
                  - {{invoiceItem.discountAmount|number}} €
                </td>
              </tr>
              <tr *ngIf="invoiceItem.vat" class="mat-row">
                <td class="mat-cell">
                  <div class="sub-row">{{invoiceItem.vat.label}}</div>
                </td>
                <td class="td-price mat-cell">
                  {{invoiceItem.vatPrice|number}} €
                </td>
              </tr>
            </ng-container>
          </table>
        </ng-container>
        <table class="total-table mat-table full-width">
          <tr class=" mat-header-row">
            <th class="mat-header-cell" colspan="2">Total</th>
          </tr>
          <tr class="mat-row">
            <td class="mat-cell">
              Prix total HT
            </td>
            <td class="td-price mat-cell">
              {{getPreTaxPriceTotal() |number}} €
            </td>
          </tr>
          <tr class="mat-row" *ngIf="getDiscountTotal() && getDiscountTotal()>0">
            <td class="mat-cell">
              Remise totale
            </td>
            <td class="td-price remise mat-cell">
              - {{getDiscountTotal()|number}} €
            </td>
          </tr>
          <tr class="mat-row" *ngIf="getDiscountTotal() && getDiscountTotal()>0">
            <td class="mat-cell">
              Total HT avec remise
            </td>
            <td class="td-price mat-cell">
              {{getPreTaxPriceTotal()-getDiscountTotal()|number}} €
            </td>
          </tr>
          <ng-container *ngIf="getApplicableVat().length>0">
            <tr *ngFor="let vat of getApplicableVat()">
              <td class="mat-cell">
                Total {{vat.label}} sur la base de {{vat.base |number}} €
              </td>
              <td class="td-price mat-cell">
                {{vat.total|number}} €
              </td>
            </tr>
          </ng-container>
          <tr class="mat-row">
            <td class="mat-cell">
              Total TTC
            </td>
            <td class="td-price mat-cell">
              {{getPriceTotal()|number}} €
            </td>
          </tr>
        </table>
        <invoice-payment-table [invoice]="invoice"></invoice-payment-table>
      </div>
    </mat-tab>
    <mat-tab label="Associer un paiement"
      *ngIf="getAmountRemaining(invoice)>0 && invoice.invoiceStatus.id==invoiceStatusSend.id">
      <invoice-payment (stateChanged)=" onStateChange()" [invoice]="invoice">
      </invoice-payment>
    </mat-tab>
    <mat-tab label="Historique" *ngIf="invoice.id">
      <history [entity]="invoice" [entityType]="INVOICE_ENTITY_TYPE"></history>
    </mat-tab>
  </mat-tab-group>
</div>
