<div class="mat-elevation-z2 form-div" *ngIf="invoice">
  <mat-tab-group animationDuration="0ms" #tabs>
    <mat-tab label="Détail">
      <div class="full-width top">
        <div class="chips-status">
          <chips-status [status]="invoice.invoiceStatus.code" [value]="invoice.invoiceStatus.label"></chips-status>
        </div>
        <p>Emis<span *ngIf="!invoice.isCreditNote">e</span> à Paris, le {{invoice.createdDate|date:'dd/MM/yyyy à
          HH:mm'}}<span *ngIf="getLetteringDate(invoice)">, lettrée le {{getLetteringDate(invoice)|date:'dd/MM/yyyy à
            HH:mm'}}</span><span *ngIf="invoice.commandNumber">,<br> Numéro de commande :
            {{invoice.commandNumber}}</span><span *ngIf="invoice.manualAccountingDocumentNumber">,<br> Référence de
            pièce la comptable : {{invoice.manualAccountingDocumentNumber}}</span>
          <span *ngIf="invoice.manualAccountingDocumentDate">,<br> Date de la
            pièce comptable : {{invoice.manualAccountingDocumentDate|date:'dd/MM/yyyy'}}</span>
        </p>
        <div class="invoice-title" *ngIf="invoice.creditNote">
          <span>Avoir n°{{invoice.creditNote.id}} émis à Paris, le
            {{invoice.creditNote.createdDate|date:'dd/MM/yyyy à HH:mm'}}</span>
          <mat-icon color="accent" (click)="openRoute($event,'/invoicing/view/'+invoice.creditNote.id)"
            (auxclick)="openRoute($event,'/invoicing/view/'+invoice.creditNote.id)" matTooltip="Voir l'avoir"
            color="accent" class="pointer invoice-chip">visibility
          </mat-icon>
        </div>
        <div class="invoice-title"
          *ngIf="(invoice.isCreditNote || invoice.isProviderCreditNote) && invoice.reverseCreditNote">
          <span>Pour la facture n°{{invoice.reverseCreditNote.id}} émise à Paris, le
            {{invoice.reverseCreditNote.createdDate|date:'dd/MM/yyyy à HH:mm'}}</span>
          <mat-icon color="accent" (click)="openRoute($event,'/invoicing/view/'+invoice.reverseCreditNote.id)"
            (auxclick)="openRoute($event,'/invoicing/view/'+invoice.reverseCreditNote.id)" matTooltip="Voir la facture"
            color="accent" class="pointer invoice-chip">visibility
          </mat-icon>
        </div>
        <p *ngIf="invoice.customerOrder">Commande n°{{invoice.customerOrder.id}}
          <mat-icon color="accent" matTooltip="Voir la commande" color="accent" class="pointer"
            (click)="openRoute($event,'/order/'+invoice.customerOrder.id)"
            (auxclick)="openRoute($event,'/order/'+invoice.customerOrder.id)">visibility
          </mat-icon>
        </p>
        <p *ngIf="invoice.customerOrderForInboundInvoice">Commande n°{{invoice.customerOrderForInboundInvoice.id}}
          <mat-icon color="accent" matTooltip="Voir la commande" color="accent" class="pointer"
            (click)="openRoute($event,'/order/'+invoice.customerOrderForInboundInvoice.id)"
            (auxclick)="openRoute($event,'/order/'+invoice.customerOrderForInboundInvoice.id)">visibility
          </mat-icon>
        </p>
        <p *ngIf="invoice.attachments && !invoice.isCreditNote"> <single-attachment [entity]="invoice"
            [entityType]="INVOICE_ENTITY_TYPE.entityType" [editMode]="false"
            [attachmentTypeToDisplay]="attachmentTypeInvoice">
          </single-attachment>
        </p>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width  description-table ">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell "
                *ngIf="invoice.isInvoiceFromProvider==undefined || invoice.isInvoiceFromProvider==false &&invoice.isProviderCreditNote==false">
                Affaire(s)</th>
              <th class="mat-mdc-header-cell mdc-data-table__header-cell "
                *ngIf="invoice.isInvoiceFromProvider==undefined || invoice.isInvoiceFromProvider==false&&invoice.isProviderCreditNote==false">
                Payeur</th>
              <th class="mat-mdc-header-cell mdc-data-table__header-cell "
                *ngIf="invoice.isInvoiceFromProvider==undefined || invoice.isInvoiceFromProvider==false&&invoice.isProviderCreditNote==false">
                Donneur d'ordre
              </th>
              <th class="mat-mdc-header-cell mdc-data-table__header-cell "
                *ngIf="invoice.isInvoiceFromProvider || invoice.isProviderCreditNote">
                Fournisseur</th>
            </tr>
          </thead>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell  td-info"
              *ngIf="invoice.isInvoiceFromProvider==undefined || invoice.isInvoiceFromProvider==false&&invoice.isProviderCreditNote==false">
              <p>{{getAffaireList(invoice)}}</p>
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  td-info"
              *ngIf="invoice.isInvoiceFromProvider==undefined || invoice.isInvoiceFromProvider==false&&invoice.isProviderCreditNote==false">
              <p>{{invoice.billingLabel}}</p>
              <p>{{invoice.billingLabelAddress}}</p>
              <p>{{invoice.billingLabelPostalCode}} {{invoice.billingLabelCity?invoice.billingLabelCity.label:""}}
                {{invoice.billingLabelCountry?invoice.billingLabelCountry.label:""}}</p>
              <p *ngIf="invoice.billingLabelIntercommunityVat">N° de TVA : {{invoice.billingLabelIntercommunityVat}}</p>
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  td-info"
              *ngIf="invoice.isInvoiceFromProvider==undefined || invoice.isInvoiceFromProvider==false &&  invoice.isProviderCreditNote==false">
              <p>{{getCustomerOrderName(invoice)}} <mat-icon color="accent" matTooltip="Voir le donneur d'ordre"
                  color="accent" class="pointer" (click)="openCustomerOrderLink($event )"
                  (auxclick)="openCustomerOrderLink($event)">visibility</mat-icon></p>
              <p>{{getCustomerOrder(invoice).address}}</p>
              <p>{{getCustomerOrder(invoice).postalCode}}
                {{getCustomerOrder(invoice).city?getCustomerOrder(invoice).city.label:""}}{{getCustomerOrder(invoice).country?getCustomerOrder(invoice).country.label:""}}
              </p>
              <p>Compte client :
                {{getCustomerOrder(invoice).accountingAccountCustomer.principalAccountingAccount.code}}{{getCustomerOrder(invoice).accountingAccountCustomer.accountingAccountSubNumber}}
                <br />Compte fournisseur :
                {{getCustomerOrder(invoice).accountingAccountProvider.principalAccountingAccount.code}}{{getCustomerOrder(invoice).accountingAccountProvider.accountingAccountSubNumber}}
              </p>
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  td-info"
              *ngIf="invoice.isInvoiceFromProvider || invoice.isProviderCreditNote">
              <p>Fournisseur : {{getProviderName(invoice)}}
              </p>
            </td>
          </tr>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width  description-table "
          *ngIf="invoice.provider">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Fournisseur</th>
            </tr>
          </thead>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell  td-info">
              <p>{{invoice.provider.label}} <mat-icon color="accent" matTooltip="Voir le fournisseur" color="accent"
                  class="pointer" (click)="openRoute($event,'/administration/provider/'+invoice.provider.id)"
                  (auxclick)="openRoute($event,'/administration/provider/'+invoice.provider.id)">visibility
                </mat-icon></p>
              <p>IBAN : {{invoice.provider.iban}}</p>
              <p>Compte fournisseur :
                {{invoice.provider.accountingAccountProvider.principalAccountingAccount.code}}{{invoice.provider.accountingAccountProvider.accountingAccountSubNumber}}
              </p>
            </td>
          </tr>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width  description-table "
          *ngIf="invoice.confrere && (invoice.isInvoiceFromProvider || invoice.isProviderCreditNote)">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Confrère (fournisseur)</th>
            </tr>
          </thead>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell  td-info">
              <p>{{invoice.confrere.label}}</p>
            </td>
          </tr>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width  description-table "
          *ngIf="invoice.tiers && (invoice.isInvoiceFromProvider || invoice.isProviderCreditNote)">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Tiers (fournisseur)</th>
            </tr>
          </thead>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell  td-info">
              <p>{{invoice.tiers.denomination?invoice.tiers.denomination:invoice.tiers.firstname +' ' +
                invoice.tiers.lastname}}
              <p>
            </td>
          </tr>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width  description-table "
          *ngIf="invoice.responsable && (invoice.isInvoiceFromProvider || invoice.isProviderCreditNote)">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell ">Responsable (fournisseur)</th>
            </tr>
          </thead>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell  td-info">
              <p>{{invoice.responsable.firstname +' ' + invoice.responsable.lastname}}
              <p>
            </td>
          </tr>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width container-affaire "
          *ngIf="invoice.customerOrder">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell " colspan="2">Facture</th>
            </tr>
          </thead>
          <ng-container *ngFor="let asso of invoice.customerOrder.assoAffaireOrders;let indexAsso = index">
            <tr class="mat-mdc-row mdc-data-table__row ">
              <td class="mat-mdc-cell mdc-data-table__cell  affaire" colspan="2"
                *ngIf="asso.affaire && asso.affaire.denomination">
                {{asso.affaire.denomination}}
              </td>
              <td class="mat-mdc-cell mdc-data-table__cell  affaire" colspan="2"
                *ngIf="asso.affaire && asso.affaire.firstname">
                {{asso.affaire.firstname}} - {{asso.affaire.lastname}} -
              </td>
            </tr>
            <ng-container *ngFor="let provision of asso.provisions">
              <tr class="mat-mdc-row mdc-data-table__row " *ngIf="provision.provisionType">
                <td class="mat-mdc-cell mdc-data-table__cell  affaire" colspan="2">
                  {{provision.provisionType.label}}
                </td>
              </tr>
              <ng-container *ngFor="let invoiceItem of provision.invoiceItems;let indexInvoiceItem = index">
                <tr class="mat-mdc-row mdc-data-table__row ">
                  <td class="mat-mdc-cell mdc-data-table__cell ">
                    {{invoiceItem.label}}
                  </td>
                  <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
                    {{invoiceItem.preTaxPrice|number}} €
                  </td>
                </tr>
                <tr class="mat-mdc-row mdc-data-table__row "
                  *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0">
                  <td class="mat-mdc-cell mdc-data-table__cell ">
                    Remise
                  </td>
                  <td class="mat-mdc-cell mdc-data-table__cell  td-price remise ">
                    - {{invoiceItem.discountAmount|number}} €
                  </td>
                </tr>
                <tr class="mat-mdc-row mdc-data-table__row " *ngIf="invoiceItem.vat">
                  <td class="mat-mdc-cell mdc-data-table__cell ">
                    {{invoiceItem.vat.label}}
                  </td>
                  <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
                    {{invoiceItem.vatPrice|number}} €
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </ng-container>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table full-width container-affaire"
          *ngIf="!invoice.customerOrder">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell " colspan="2">Facture</th>
            </tr>
          </thead>
          <ng-container *ngFor="let invoiceItem of invoice.invoiceItems;let indexInvoiceItem = index">
            <tr class="mat-mdc-row mdc-data-table__row ">
              <td class="mat-mdc-cell mdc-data-table__cell ">
                {{invoiceItem.label}}
              </td>
              <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
                {{invoiceItem.preTaxPrice|number}} €
              </td>
            </tr>
            <tr class="mat-mdc-row mdc-data-table__row "
              *ngIf="invoiceItem.discountAmount && invoiceItem.discountAmount>0">
              <td class="mat-mdc-cell mdc-data-table__cell ">
                Remise
              </td>
              <td class="mat-mdc-cell mdc-data-table__cell  td-price remise ">
                - {{invoiceItem.discountAmount|number}} €
              </td>
            </tr>
            <tr class="mat-mdc-row mdc-data-table__row " *ngIf="invoiceItem.vat">
              <td class="mat-mdc-cell mdc-data-table__cell ">
                {{invoiceItem.vat.label}}
              </td>
              <td class="mat-mdc-cell mdc-data-table__cell  td-price">
                {{invoiceItem.vatPrice|number}} €
              </td>
            </tr>
          </ng-container>
        </table>
        <table class="mat-table mat-mdc-table mdc-data-table__table total-table full-width">
          <thead>
            <tr class="mat-mdc-header-row mdc-data-table__header-row ">
              <th class="mat-mdc-header-cell mdc-data-table__header-cell " colspan="2">Total</th>
            </tr>
          </thead>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell ">
              Prix total HT
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
              {{getPreTaxPriceTotal() |number}} €
            </td>
          </tr>
          <tr class="mat-mdc-row mdc-data-table__row " *ngIf="getDiscountTotal() && getDiscountTotal()>0">
            <td class="mat-mdc-cell mdc-data-table__cell ">
              Remise totale
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell td-price remise ">
              - {{getDiscountTotal()|number}} €
            </td>
          </tr>
          <tr class="mat-mdc-row mdc-data-table__row " *ngIf="getDiscountTotal() && getDiscountTotal()>0">
            <td class="mat-mdc-cell mdc-data-table__cell ">
              Total HT avec remise
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
              {{getPreTaxPriceTotal()-getDiscountTotal()|number}} €
            </td>
          </tr>
          <ng-container *ngIf="getApplicableVat().length>0">
            <tr *ngFor="let vat of getApplicableVat()">
              <td class="mat-mdc-cell mdc-data-table__cell ">
                Total {{vat.label}} sur la base de {{vat.base |number}} €
              </td>
              <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
                {{vat.total|number}} €
              </td>
            </tr>
          </ng-container>
          <tr class="mat-mdc-row mdc-data-table__row ">
            <td class="mat-mdc-cell mdc-data-table__cell ">
              Total TTC
            </td>
            <td class="mat-mdc-cell mdc-data-table__cell  td-price ">
              {{getPriceTotal()|number}} €
            </td>
          </tr>
        </table>
        <invoice-payment-table [invoice]="invoice"></invoice-payment-table>
      </div>
    </mat-tab>
    <mat-tab label="Associer un paiement" *ngIf="getAmountRemaining(invoice)>0 && (invoice.invoiceStatus.id==invoiceStatusSend.id ||invoice.invoiceStatus.id==invoiceStatusReceived.id
      ||invoice.invoiceStatus.id==invoiceStatusCreditNoteReceived.id)">
      <invoice-payment (stateChanged)=" onStateChange()" [invoice]="invoice">
      </invoice-payment>
    </mat-tab>
    <mat-tab label="Suivi" *ngIf="invoice.id && invoice.invoiceStatus.id==invoiceStatusSend.id ">
      <div>
        <ul>
          <li [ngClass]="{'color-warn':beforeToday(invoice.dueDate)}">Echéance de paiement : {{invoice.dueDate |
            date:'dd/MM/yyyy'}}</li>
          <li *ngIf="invoice.firstReminderDateTime && beforeToday(invoice.firstReminderDateTime)">Relance n°1 :
            {{invoice.firstReminderDateTime |date:'dd/MM/yyyy'}}
            <chips-status class="chips-reminder" [status]="beforeToday(invoice.firstReminderDateTime)?'SENT':'WAITING'"
              [value]="beforeToday(invoice.firstReminderDateTime)?'Envoyée':'En attente'"></chips-status>
          </li>
          <li *ngIf="invoice.secondReminderDateTime && beforeToday(invoice.secondReminderDateTime)">Relance n°2 :
            {{invoice.secondReminderDateTime|date:'dd/MM/yyyy'}}
            <chips-status class="chips-reminder" [status]="beforeToday(invoice.secondReminderDateTime)?'SENT':'WAITING'"
              [value]="beforeToday(invoice.secondReminderDateTime)?'Envoyée':'En attente'"></chips-status>
          </li>
          <li *ngIf="invoice.thirdReminderDateTime && beforeToday(invoice.thirdReminderDateTime)">Relance n°3 :
            {{invoice.thirdReminderDateTime|date:'dd/MM/yyyy'}}
            <chips-status class="chips-reminder" [status]="beforeToday(invoice.thirdReminderDateTime)?'SENT':'WAITING'"
              [value]="beforeToday(invoice.thirdReminderDateTime)?'Envoyée':'En attente'"></chips-status>
          </li>
        </ul>
      </div>
      <tiers-followup [invoice]="invoice" [editMode]="true"></tiers-followup>
      <button matTooltip="Renvoyer le mail de relance" mat-fab color="accent" class="third-fab-button"
        *ngIf="invoice.invoiceStatus.code==invoiceStatusSend.code" (click)="sendMailReminder()">
        <mat-icon>mail</mat-icon>
      </button>
    </mat-tab>
    <mat-tab label="Historique" *ngIf="invoice.id">
      <history [entity]="invoice" [entityType]="INVOICE_ENTITY_TYPE"></history>
    </mat-tab>
  </mat-tab-group>
</div>
<button matTooltip="Editer la facture" mat-fab color="accent" class="fab-button" (click)="editInvoice($event)"
  *ngIf="false" (auxclick)="editInvoice($event)">
  <mat-icon>edit</mat-icon>
</button>
<button *ngIf="canCancelInvoice() && canAddCreditNote() && invoice && (invoice.invoiceStatus.code==invoiceStatusReceived.code
  || invoice.invoiceStatus.code==invoiceStatusSend.code
  || invoice.isInvoiceFromProvider && invoice.invoiceStatus.code == invoiceStatusPayed.code)"
  matTooltip="Annuler la facture" mat-fab color="accent" class="second-fab-button" (click)="cancelInvoice($event)">
  <mat-icon>close</mat-icon>
</button>
<button *ngIf="canAddCreditNote() && invoice && (invoice.invoiceStatus.code==invoiceStatusReceived.code )"
  matTooltip="Saisir un avoir" mat-fab color="accent" class="third-fab-button" (click)="addCreditNote($event)">
  <mat-icon>payments</mat-icon>
</button>