<div class="mat-elevation-z2 form-div">
  <div class=" full-width padding-top">
    <div>
      <table class="full-width">
        <tr>
          <td *ngIf="!invoice.responsable && !invoice.confrere && !invoice.provider && !invoice.competentAuthority">
            <autocomplete-tiers-individual [(model)]="invoice.tiers" [form]="invoiceForm" propertyName="tiers"
              (onOptionSelected)="fillTiers($event)" [isMandatory]="true" label="Tiers"
              [isDisabled]="!editMode || invoice.id!=undefined"
              [conditionnalRequired]="invoice.responsable==undefined && invoice.confrere==undefined && invoice.provider ==undefined  && invoice.competentAuthority ==undefined">
            </autocomplete-tiers-individual>
          </td>
          <td *ngIf="!invoice.tiers && !invoice.confrere && !invoice.provider  && !invoice.competentAuthority">
            <autocomplete-responsable [(model)]="invoice.responsable" [form]="invoiceForm" propertyName="responsable"
              (onOptionSelected)="fillResponsable($event)" [isMandatory]="true" label="Responsable"
              [isDisabled]="!editMode   || invoice.id!=undefined"
              [conditionnalRequired]="invoice.tiers==undefined && invoice.confrere==undefined && invoice.provider ==undefined && invoice.competentAuthority ==undefined">
            </autocomplete-responsable>
          </td>
          <td *ngIf="!invoice.tiers && !invoice.responsable && !invoice.provider  && !invoice.competentAuthority">
            <autocomplete-confrere label="Confrère" [(model)]="invoice.confrere" [form]="invoiceForm"
              propertyName="confrere" [isDisabled]="!editMode   || invoice.id!=undefined"
              (onOptionSelected)="fillConfrere($event)" [isMandatory]="true"
              [conditionnalRequired]="invoice.responsable==undefined && invoice.tiers==undefined && invoice.provider ==undefined && invoice.competentAuthority ==undefined">
            </autocomplete-confrere>
          </td>
          <td
            *ngIf="!invoice.tiers && !invoice.responsable && !invoice.confrere &&  !invoice.competentAuthority && invoice.isInvoiceFromProvider">
            <autocomplete-provider [(model)]=" invoice.provider" [form]="invoiceForm" propertyName="provider"
              [isMandatory]="true" [isDisabled]="!editMode   || invoice.id!=undefined"
              [conditionnalRequired]="invoice.responsable==undefined && invoice.tiers==undefined && invoice.confrere ==undefined && invoice.competentAuthority ==undefined"
              (onOptionSelected)="fillProvider($event)" label="Fournisseur"></autocomplete-provider>
          </td>
          <td
            *ngIf="!invoice.tiers && !invoice.responsable && !invoice.confrere && !invoice.provider && invoice.isInvoiceFromProvider">
            <autocomplete-competent-authority [(model)]="invoice.competentAuthority"
              [isDisabled]="!editMode   || invoice.id!=undefined" [form]="invoiceForm" propertyName="competentAuthority"
              [isMandatory]="true"
              [conditionnalRequired]="invoice.responsable==undefined && invoice.tiers==undefined && invoice.confrere ==undefined && invoice.provider==undefined"
              (onOptionSelected)="fillCompetentAuthority($event)"
              label="Autorité compétente"></autocomplete-competent-authority>
          </td>
        </tr>
        <tr>
          <td>
            <generic-toggle [(model)]="invoice.isInvoiceFromProvider" label="Est une facture entrante ?"
              [form]="invoiceForm" propertyName="isInvoiceFromProvider"
              [isDisabled]="!editMode   || invoice.id!=undefined" (onToggleChange)="emptyProvider()"></generic-toggle>
          </td>
        </tr>
      </table>
      <table class="full-width" *ngIf="!invoice.isInvoiceFromProvider">
        <tr>
          <td>
            <radio-group-billing-label [(model)]="invoice.billingLabelType" [form]="invoiceForm"
              [isDisabled]="!editMode || !isManualInvoice()" propertyName="billingLabelType"
              label="Libellé sur facture">
            </radio-group-billing-label>
          </td>
        </tr>
      </table>
      <table class="full-width"
        *ngIf="invoice.billingLabelType!=undefined && invoice.billingLabelType.code!=undefined && invoice.billingLabelType.id==billingLableTypeOther.id">
        <tr>
          <td>
            <generic-input [(model)]="invoice.billingLabel" label="Libellé" [form]="invoiceForm"
              propertyName="billingLabel" [isMandatory]="true" [maxLength]="40"
              [isDisabled]="!editMode || !isManualInvoice()">
            </generic-input>
          </td>
          <td>
            <generic-input [(model)]="invoice.billingLabelAddress" label="Adresse" [form]="invoiceForm"
              propertyName="billingAddress" [isMandatory]="true" [isDisabled]="!editMode || !isManualInvoice()"
              [maxLength]="160">
            </generic-input>
          </td>
          <td>
            <autocomplete-postal-code [(model)]="invoice.billingLabelPostalCode" [form]="invoiceForm"
              [byPassAutocompletValidator]="true" label="Code postal" [isDisabled]="!editMode || !isManualInvoice()"
              propertyName="postalCode" [isMandatory]="true"
              [conditionnalRequired]="invoice.billingLabelCountry != null && invoice.billingLabelCountry.id == countryFrance.id"
              (onOptionSelected)="fillCity($event)"></autocomplete-postal-code>
          </td>
          <td>
            <generic-input [(model)]="invoice.cedexComplement" label="Complément CEDEX" [form]="invoiceForm"
              propertyName="cedexComplement" [isMandatory]="false" [isDisabled]="!editMode || !isManualInvoice()"
              [maxLength]="20"></generic-input>
          </td>
          <td>
            <autocomplete-city [(model)]="invoice.billingLabelCity" [modelCountry]="invoice.billingLabelCountry"
              [preFilterPostalCode]="invoice.billingLabelPostalCode" [isDisabled]="!editMode || !isManualInvoice()"
              label="Ville" [form]="invoiceForm" propertyName="city" [isMandatory]="true"
              (onOptionSelected)="fillPostalCode($event)">
            </autocomplete-city>
          </td>
          <td>
            <autocomplete-country [(model)]="invoice.billingLabelCountry" [form]="invoiceForm" propertyName="country"
              label="Pays" [isDisabled]="!editMode || !isManualInvoice()" [isMandatory]="true"></autocomplete-country>
          </td>
          <td>
            <generic-toggle [(model)]="invoice.billingLabelIsIndividual" [isDisabled]="!editMode || !isManualInvoice()"
              label="Est particulier ?" [form]="invoiceForm" propertyName="billingLabelIsIndividual"></generic-toggle>
          </td>
        </tr>
      </table>
      <table class="full-width">
        <tr>
          <td>
            <generic-input [(model)]="invoice.commandNumber" label="N° de commande" [form]="invoiceForm"
              propertyName="commandNumber" [isMandatory]="false" [isDisabled]="!editMode || !isManualInvoice()"
              [maxLength]="40">
            </generic-input>
          </td>
          <td>
            <generic-input [(model)]="invoice.manualAccountingDocumentNumber" label="Référence de la pièce comptable"
              [form]="invoiceForm" propertyName="manualAccountingDocumentNumber" [isMandatory]="false"
              [isDisabled]="!editMode || !isManualInvoice()" [maxLength]="150">
            </generic-input>
          </td>
          <td *ngIf="invoice.isInvoiceFromProvider">
            <autocomplete-customer-order [(model)]="indexedCustomerOrder" [form]="invoiceForm"
              propertyName="indexedCustomerOrder" [isMandatory]="false" label="Numéro de commande Osiris"
              (onOptionSelected)="fillCustomerOrder($event)"></autocomplete-customer-order>
          </td>
        </tr>
      </table>
      <table class="full-width">
        <tr>
          <td>
            <select-payment-types [(model)]="invoice.manualPaymentType" label="Type de paiement" [form]="invoiceForm"
              *ngIf="!displayDeboursTable()" propertyName="manualPaymentType" [isMandatory]="true"
              [isDisabled]="!editMode || invoice.id!=undefined"></select-payment-types>
          </td>
          <td>
            <generic-datepicker [(model)]="invoice.dueDate" label="Date d'échéance" [form]="invoiceForm"
              *ngIf="!displayDeboursTable()" propertyName="dueDate" [isMandatory]="false"
              [isDisabled]="!editMode || invoice.id!=undefined"></generic-datepicker>
            <generic-datepicker [(model)]="invoice.manualAccountingDocumentDate" label="Date de la pièce comptable"
              [form]="invoiceForm" propertyName="manualAccountingDocumentDate" [isMandatory]="false"
              [isDisabled]="!editMode || !isManualInvoice()"></generic-datepicker>
          </td>
          <td>
            <single-attachment *ngIf="invoice.id" [entity]="invoice" [entityType]="INVOICE_ENTITY_TYPE.entityType"
              [editMode]="true" [attachmentTypeToDisplay]="attachmentTypeInvoice"
              (onUploadedFile)="updateAttachments($event)">
            </single-attachment>
          </td>
        </tr>
      </table>
      <div class=" full-width padding-bottom" *ngIf="displayDeboursTable()">
        <sort-table class="margin-bottom" (onRowClick)="selectDebour($event)" [columns]="displayedColumnsDebours"
          [refreshTable]="refreshTable.asObservable()" [values]="debours" tableName="Débours">
        </sort-table>
      </div>
      <div class=" full-width padding-bottom" *ngIf="displayDeboursTable() && this.selectedDebours">
        <div>
          <h3>Débours/frais sélectionnés :</h3>
        </div>
        <sort-table class="margin-bottom" [columns]="displayedColumnsSelectedDebours"
          [refreshTable]="refreshTable.asObservable()" [actions]="tableActionSelectedDebours" [values]="selectedDebours"
          tableName="Débours">
        </sort-table>
      </div>
    </div>
  </div>
  <div class=" full-width padding-bottom" *ngIf="!displayDeboursTable()">
    <sort-table [columns]="displayedColumns" [values]="invoiceItems" tableName="Facture Ajout" [actions]="tableAction"
      (onRowClick)="selectInvoiceItem($event)" [refreshTable]="refreshTable.asObservable()">
    </sort-table>
  </div>
  <div class="align-right" *ngIf="!displayDeboursTable()">
    <span class="mat-cell">Total TTC : {{getInvoiceTotal()}} €</span>
  </div>
  <div class="align-right" *ngIf="displayDeboursTable()">
    <span class="mat-cell">Total TTC : {{getDeboursTotal()}} €</span>
  </div>
  <div *ngIf="!displayDeboursTable()">
    <table class="full-width ">
      <tr>
        <td>
          <generic-input [(model)]="invoiceItem.label" label="Libellé" [form]="invoiceForm" propertyName="label"
            [isMandatory]="true" [isDisabled]="!editMode || invoice.id!=undefined" [maxLength]="200"></generic-input>
        </td>
        <td>
          <autocomplete-billing-item [(model)]="invoiceItem.billingItem" [form]="invoiceForm"
            label="Poste de facturation" propertyName="Poste de facturation" [isMandatory]="true"
            (onOptionSelected)="fillBillingItem(invoiceItem,invoiceItem.billingItem)"
            [isDisabled]="!editMode || invoice.id!=undefined">
          </autocomplete-billing-item>
        </td>
      </tr>
      <tr *ngIf="invoiceItem.billingItem">
        <td>
          <autocomplete-accounting-account *ngIf="invoiceItem.billingItem.billingType.accountingAccountProduct"
            [(model)]="invoiceItem.billingItem.billingType.accountingAccountProduct" [form]="invoiceForm"
            propertyName="accountingAccountProduct" [isMandatory]="false" [isDisabled]="true"
            label="Compte comptable produit">
          </autocomplete-accounting-account>
        </td>
        <td>
          <autocomplete-accounting-account *ngIf="invoiceItem.billingItem.billingType.accountingAccountCharge"
            [(model)]="invoiceItem.billingItem.billingType.accountingAccountCharge" [form]="invoiceForm"
            propertyName="accountingAccountCharge" [isMandatory]="false" [isDisabled]="true"
            label="Compte comptable charge">
          </autocomplete-accounting-account>
        </td>
      </tr>
    </table>
    <table class="full-width">
      <tr>
        <td>
          <generic-input [(model)]="invoiceItem.preTaxPrice" label="Prix HT" [form]="invoiceForm"
            propertyName="preTaxPrice" [isMandatory]="true" [isDisabled]="!editMode || invoice.id!=undefined"
            type="number"></generic-input>
        </td>
        <td>
          <select-vat [(model)]="invoiceItem.vat" label="TVA applicable" [form]="invoiceForm" propertyName="vat"
            [isMandatory]="true"
            [isDisabled]="!editMode || invoice.id!=undefined || (invoiceItem.billingItem && invoiceItem.billingItem.billingType.isOverrideVat)"></select-vat>
        </td>
        <td>
          <generic-input [(model)]="invoiceItem.discountAmount" label="Remise totale" [form]="invoiceForm"
            propertyName="discountAmount" [isMandatory]="false" [isDisabled]="!editMode || invoice.id!=undefined"
            type="number"></generic-input>
        </td>
      </tr>
    </table>
  </div>
</div>
<button matTooltip="Ajouter une ligne de facturation" mat-fab color="accent" class="second-fab-button"
  *ngIf="!editMode   || invoice.id==undefined" (click)="addInvoiceItem()">
  <mat-icon>add</mat-icon>
</button>
<button matTooltip="Enregistrer la facture" mat-fab color="warn" class="fab-button" (click)="saveInvoice()">
  <mat-icon>save</mat-icon>
</button>