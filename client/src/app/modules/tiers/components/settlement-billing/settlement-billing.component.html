<ng-template #accordionTools>
  <mat-panel-description>
    <mat-icon matTooltip="Ouvrir tous les onglets" (click)="accordion!.openAll();$event.stopPropagation();"
      class="pointer">
      unfold_more_double</mat-icon>
    <mat-icon matTooltip="Fermer tous les autres onglets" (click)="accordion!.closeAll();" class="pointer">
      unfold_less_double</mat-icon>
  </mat-panel-description>
</ng-template>
<form [formGroup]="settlementBillingForm" *ngIf="tiers">
  <div class="mat-accordion-container full-width">
    <fieldset [disabled]="editMode==false" class="fieldset-no-border">
      <mat-accordion multi>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Justificatif de parution
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <addressing [displayMailCC]="false" [editMode]=" editMode" [document]="publicationDocument"
            [displayPaperCopy]="true" [displayNumberMailing]="true">
          </addressing>
        </mat-expansion-panel>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Kbis
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <addressing [editMode]="editMode" [document]="kbisDocument" [displayMailCC]="instanceOfResponsable(tiers)">
          </addressing>
        </mat-expansion-panel>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              CFE
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <addressing [editMode]="editMode" [document]="cfeDocument" [displayMailCC]="instanceOfResponsable(tiers)">
          </addressing>
        </mat-expansion-panel>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Facture
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <table class="full-width">
            <tr>
              <td>
                <radio-group-billing-label [(model)]="billingDocument.billingLabelType" [form]="settlementBillingForm"
                  [isDisabled]="!editMode" propertyName="billingLabelType" label="Libellé sur facture">
                </radio-group-billing-label>
              </td>
            </tr>
          </table>
          <table class="full-width"
            *ngIf="billingDocument.billingLabelType!=undefined && billingDocument.billingLabelType.code!=undefined && billingDocument.billingLabelType.id==billingLableTypeOther.id">
            <tr>
              <td>
                <generic-input [(model)]="billingDocument.billingLabel" label="Libellé" [form]="settlementBillingForm"
                  propertyName="billingLabel" [isMandatory]="true" [isDisabled]="!editMode"></generic-input>
              </td>
              <td>
                <generic-input [(model)]="billingDocument.billingAddress" label="Adresse" [form]="settlementBillingForm"
                  propertyName="billingAddress" [isMandatory]="true" [isDisabled]="!editMode"></generic-input>
              </td>
              <td>
                <autocomplete-postal-code [(model)]="billingDocument.billingPostalCode" [form]="settlementBillingForm"
                  [byPassAutocompletValidator]="true" propertyName="postalCode" [isMandatory]="true" label="Code postal"
                  [isDisabled]="!editMode"
                  [conditionnalRequired]="billingDocument.billingLabelCountry != null && billingDocument.billingLabelCountry.id == countryFrance.id"
                  (onOptionSelected)="fillCity($event)"></autocomplete-postal-code>
              </td>
              <td>
                <autocomplete-city [(model)]="billingDocument.billingLabelCity" [isDisabled]="!editMode" label="Ville"
                  [preFilterPostalCode]="billingDocument.billingPostalCode"
                  [modelCountry]="billingDocument.billingLabelCountry" [form]="settlementBillingForm"
                  propertyName="city" [isMandatory]="true" (onOptionSelected)="fillPostalCode($event)">
                </autocomplete-city>
              </td>
              <td>
                <autocomplete-country [(model)]="billingDocument.billingLabelCountry" [form]="settlementBillingForm"
                  label="Pays" [isDisabled]="!editMode" propertyName="country" [isMandatory]="true">
                </autocomplete-country>
              </td>
              <td>
                <generic-toggle [(model)]="billingDocument.billingLabelIsIndividual" label="Est particulier ?"
                  [form]="settlementBillingForm" propertyName="billingLabelIsIndividual"></generic-toggle>
              </td>
            </tr>
          </table>
          <table class="full-width">
            <tr>
              <td>
                <generic-toggle [(model)]="billingDocument.isResponsableOnBilling" label="Responsable sur facture ?"
                  [form]="settlementBillingForm" propertyName="isResponsableOnBilling"></generic-toggle>
              </td>
            </tr>
          </table>
          <table class="full-width">
            <tr>
              <td>
                <generic-toggle [(model)]="billingDocument.isCommandNumberMandatory"
                  label="Numéro de commande obligatoire ?" [form]="settlementBillingForm"
                  propertyName="isCommandNumberMandatory"></generic-toggle>
              </td>
              <td *ngIf="billingDocument.isCommandNumberMandatory">
                <generic-input [(model)]="billingDocument.commandNumber" label="N° de commande annuel"
                  [form]="settlementBillingForm" propertyName="commandNumber" [maxLength]="40"></generic-input>
              </td>
            </tr>
          </table>
          <addressing [editMode]="editMode" [document]="billingDocument " [onlyMail]="true"
            [displayMailCC]="instanceOfResponsable(tiers)"></addressing>
        </mat-expansion-panel>
        <mat-expansion-panel *ngIf="instanceOfTiers(tiers) && !instanceOfResponsable(tiers)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Règlement
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <table class="full-width">
            <tr>
              <td>
                <select-payment-types [(model)]="tiers.paymentType" label="Type" [form]="settlementBillingForm"
                  propertyName="paymentType" [isMandatory]="true" [isDisabled]="!editMode"
                  [filteredPaymentType]="[paymentTypePrelevement,paymentTypeVirement,paymentTypeCB, paymentTypeEspeces]">
                </select-payment-types>
              </td>
              <td *ngIf="tiers  && tiers.paymentType && tiers.paymentType.id==paymentTypePrelevement.id">
                <generic-input [(model)]="tiers.paymentIban" label="IBAN" [form]="settlementBillingForm"
                  propertyName="paymentIban" [isMandatory]="false" [isDisabled]="!editMode" [maxLength]="40">
                </generic-input>
              </td>
              <td *ngIf="tiers&& tiers.paymentType && tiers.paymentType.id==paymentTypePrelevement.id">
                <generic-toggle [(model)]="tiers.isSepaMandateReceived" label="Mandat SEPA reçu ?"
                  [form]="settlementBillingForm" propertyName="isSepaMandateReceived"></generic-toggle>
              </td>
            </tr>
            <tr>
              <td>
                <generic-toggle [(model)]="tiers.isProvisionalPaymentMandatory" label="Provision obligatoire ?"
                  [form]="settlementBillingForm" propertyName="isProvisionalPaymentMandatory"></generic-toggle>
              </td>
              <td>
                <select-payment-deadline [(model)]="dunningDocument.paymentDeadlineType" label="Délai de paiement"
                  [form]="settlementBillingForm" propertyName="paymentDeadlineType" [isDisabled]="!editMode">
                </select-payment-deadline>
              </td>
            </tr>
          </table>
        </mat-expansion-panel>
        <mat-expansion-panel *ngIf="instanceOfTiers(tiers) && !instanceOfResponsable(tiers)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Remboursement
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <table class="full-width">
            <tr>
              <td>
                <generic-toggle [(model)]="refundDocument.isRefundable" label="Remboursement ?"
                  [form]="settlementBillingForm" propertyName="isRefundable"></generic-toggle>
              </td>
              <td *ngIf="refundDocument.isRefundable">
                <select-refund-type [(model)]="refundDocument.refundType" label="Type de remboursement"
                  [isDisabled]="!editMode" [form]="settlementBillingForm" propertyName="refundType">
                </select-refund-type>
              </td>
              <td
                *ngIf="refundDocument.isRefundable && refundDocument !=undefined && refundDocument.refundType!=undefined && refundDocument.refundType.code!=undefined && refundDocument.refundType.id==refundTypeVirement.id">
                <generic-input [(model)]="refundDocument.refundIBAN" label="IBAN" [form]="settlementBillingForm"
                  propertyName="refundIBAN" [isMandatory]="false" [isDisabled]="!editMode" [maxLength]="40">
                </generic-input>
              </td>
            </tr>
          </table>
          <addressing [editMode]="editMode" [document]="refundDocument" *ngIf="refundDocument.isRefundable"
            [onlyMail]="true">
          </addressing>
        </mat-expansion-panel>
        <mat-expansion-panel *ngIf="instanceOfTiers(tiers) && !instanceOfResponsable(tiers)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Relevés de compte
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <table class="full-width">
            <tr>
              <td>
                <radio-group-billing-closure [(model)]="billingClosureDocument.billingClosureType" [isMandatory]="true"
                  [isDisabled]="!editMode" [form]="settlementBillingForm" propertyName="billingClosureType"
                  label="Type">
                </radio-group-billing-closure>
              </td>
              <td>
                <radio-group-billing-closure-recipient [(model)]="billingClosureDocument.billingClosureRecipientType"
                  [isDisabled]="!editMode" [isMandatory]="true" [form]="settlementBillingForm"
                  propertyName="billingClosureRecipientType" label="Destinataire(s)">
                </radio-group-billing-closure-recipient>
              </td>
              <td>
                <addressing [editMode]="editMode" [document]="billingClosureDocument" [hideConsignee]="true"
                  [onlyMail]="true"
                  [hideOverriding]="!billingClosureDocument.billingClosureRecipientType || !billingClosureDocument.billingClosureRecipientType.code "
                  [displayMailCC]="instanceOfResponsable(tiers)"></addressing>
              </td>
            </tr>
          </table>
        </mat-expansion-panel>
        <mat-expansion-panel *ngIf="instanceOfTiers(tiers) && !instanceOfResponsable(tiers)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              Reçu de provision / chèque du trésor public
            </mat-panel-title>
            <ng-template [ngTemplateOutlet]="accordionTools"></ng-template>
          </mat-expansion-panel-header>
          <addressing [editMode]="editMode" [document]="provisionalReceiptDocument" [hideAdressing]="true"
            [onlyMail]="true"></addressing>
        </mat-expansion-panel>
      </mat-accordion>
    </fieldset>
  </div>
</form>
