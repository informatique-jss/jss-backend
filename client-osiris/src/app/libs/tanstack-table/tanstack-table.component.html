<div class="row">
  <div class="col-12">
    <div class="" [ngClass]="className">
      <div class="card-header justify-content-between align-items-center" *ngIf="title">
        <h5 class="card-title">{{title}}</h5>
      </div>
      <div class="card-body p-0">
        <div class="card-header justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <div class="app-search">
              <input type="search" class="form-control" [(ngModel)]="searchValue"
                (input)="table.setGlobalFilter($any($event.target).value)" placeholder="Rechercher...">
              <lucide-angular [img]="LucideSearch" class="app-search-icon text-muted" />
            </div>
            @if(actions && actions.length>0 ){
            <div class="d-flex gap-2">
              @if(isDisplayActionMenu()){
              <div class="btn-group" ngbDropdown>
                <button type="button" class="btn btn-secondary" ngbDropdownToggle><lucide-angular [img]="LucideSettings"
                    class="text-muted me-1" /> Actions
                </button>
                <div ngbDropdownMenu>
                  <ng-container *ngTemplateOutlet="actionsMenu; context: { actionClick: clickOnAction.bind(this) }">
                  </ng-container>
                </div>
              </div>
              }
              @for(action of actions; track action.label){
              @if(action.isDisplayOutOfMenu){
              <div class="btn-group" ngbDropdown>
                <button type="button" class="btn " [disabled]="isActionDisabled(action)"
                  [ngClass]="action.buttonClass?action.buttonClass:'btn-primary'"
                  (click)="clickOnAction(action)">{{action.label}}
                </button>
              </div>
              }
              }
            </div>
            }
          </div>
          <div class="d-flex align-items-center gap-2">
            <div>
              <select class="form-select form-control my-1 my-md-0" [ngModel]="table.getState().pagination.pageSize"
                (ngModelChange)="setPageSize($event)">
                <option [ngValue]="5">5</option>
                <option [ngValue]="10">10</option>
                <option [ngValue]="15">15</option>
                <option [ngValue]="20">20</option>
                <option [ngValue]="adaptedPageSize">{{adaptedPageSize}} (adapt√©)</option>
              </select>
            </div>
            <button class="btn btn-default btn-icon" (click)="exportToExcel()"> <lucide-angular [img]="LucideDownload"
                class="app-search-icon text-muted" /> </button>
          </div>
        </div>
        <div [ngClass]="['table-responsive', className]">
          <table class="table table-hover table-responsive table-custom table-centered table-select w-100 mb-0">

            @if (showHeaders) {
            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
              @for (headerGroup of table.getHeaderGroups(); track headerGroup) {
              <tr class="text-uppercase fs-xxs">
                @for (header of headerGroup.headers; track header.id) {
                <th (click)="header.column.toggleSorting()"
                  [style.cursor]="header.column.getCanSort() ? 'pointer' : 'default'" style="user-select: none">
                  <div class="d-flex align-items-center">
                    @if (header.column.id === 'select') {
                    <input type="checkbox" class="form-check-input form-check-input-light fs-14"
                      [checked]="table.getIsAllPageRowsSelected()" [indeterminate]="table.getIsSomePageRowsSelected()"
                      (change)="onToggleAllPageRows($any($event.target).checked)" />
                    } @else {
                    <ng-container *flexRender="header.column.columnDef.header; props: header.getContext()">
                      {{ header.column.columnDef.header }}
                    </ng-container>
                    }

                    @if (header.column.getCanSort()) {
                    @switch (header.column.getIsSorted()) {
                    @case ('asc') {
                    <ng-icon name="tablerArrowUp" class="ms-1" />
                    }
                    @case ('desc') {
                    <ng-icon name="tablerArrowDown" class="ms-1" />
                    }
                    }
                    }
                  </div>
                </th>
                }
              </tr>
              }
            </thead>
            }

            <tbody>
              @if (table.getRowModel().rows.length === 0) {
              <tr>
                <td [attr.colspan]="columns.length" class="text-center py-3 text-muted">
                  {{ emptyMessage }}
                </td>
              </tr>
              }

              @for (row of table.getRowModel().rows; track row.id) {
              <tr>
                @for (cell of row.getVisibleCells(); track cell.id) {
                <td class="pointer" (dblclick)="doubleClickOnCell(row,cell.column)"
                  (contextmenu)="onRightClick($event, row)">
                  @if (cell.column.id === 'select') {
                  <input type="checkbox" class="form-check-input form-check-input-light fs-14"
                    [checked]="cell.row.getIsSelected()"
                    (change)="cell.row.toggleSelected($any($event.target).checked)" />
                  } @else {
                  <ng-container *flexRender="cell.column.columnDef.cell; props: cell.getContext(); let cellValue">
                    {{ cellValue }}
                  </ng-container>

                  }

                </td>
                }
              </tr>
              }
            </tbody>
          </table>
        </div>
        <div class="card-footer border-0">
          <tanstack-table-pagination [totalItems]="table.getFilteredRowModel().rows.length"
            [start]="table.getState().pagination.pageIndex * table.getState().pagination.pageSize + 1"
            [end]="Math.min(((table.getState().pagination.pageIndex + 1) * table.getState().pagination.pageSize > table.getFilteredRowModel().rows.length ? table.getFilteredRowModel().rows.length : (table.getState().pagination.pageIndex + 1) * table.getState().pagination.pageSize))"
            (previousPage)="this.table.previousPage();" [canPreviousPage]="table.getCanPreviousPage()"
            [pageCount]="table.getPageCount()" [pageIndex]="table.getState().pagination.pageIndex"
            (setPageIndex)="table.setPageIndex($event)" (nextPage)="this.table.nextPage()" [showInfo]="true"
            [canNextPage]="table.getCanNextPage()"></tanstack-table-pagination>
        </div>

      </div>
    </div>
  </div>
</div>


<div #contextMenu ngbDropdown #contextMenuDropdown="ngbDropdown" class="dropdown-menu show" [style.position]="'fixed'"
  [autoClose]="false" [style.top]="contextMenuPosition.top" [style.left]="contextMenuPosition.left"
  (click)="$event.stopPropagation()" *ngIf="isMenuVisible">
  <ng-container *ngTemplateOutlet="actionsMenu; context: { actionClick: clickOnAction.bind(this) }">
  </ng-container>
</div>

<ng-template #actionsMenu let-actionClick="actionClick">
  @for(action of actions; track action.label){
  @if(!action.isDisplayOutOfMenu){
  @if(action.isDivider){
  <div class="dropdown-divider"></div>
  }@else{
  <a ngbDropdownItem (click)="clickOnAction(action)" class="pointer"
    [disabled]="isActionDisabled(action)">{{action.label}}</a>
  }
  }
  }
</ng-template>
