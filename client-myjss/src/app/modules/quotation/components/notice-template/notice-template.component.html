<div class="quotation-container p-4">
  <div class="row">

    <div class="col-md-7 px-4">
      <form [formGroup]="form" class="mb-4" *ngIf="service">

        <!--============== GENERIC BLOC ===============-->
        <!-- Block title -->
        <h4 class="mb-3">Informations générales</h4>
        <div class="row row-cols-1 row-cols-lg-3 g-3">

          <!-- Loop over placeholder entries -->
          <div class="col" [ngClass]="{'w-100': placeholder.dataType === SERVICE_FIELD_TYPE_TEXTAREA}"
            *ngFor="let placeholder of placeholdersMap.get('#')">

            <!-- TEXT -->
            <div>
              <generic-input *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_TEXT" [(model)]="placeholder.label"
                [label]="placeholder.label" [form]="form" [propertyName]="placeholder.code + '_' + placeholder.id"
                [isDisabled]="false" [isMandatory]="false" [maxLength]="255">
              </generic-input>
            </div>

            <!-- TEXTAREA -->
            <div>
              <generic-textarea *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_TEXTAREA"
                [(model)]="placeholder.value" [label]="placeholder.label" [form]="form"
                [propertyName]="placeholder.code + '_' + placeholder.id" [isDisabled]="false" [isMandatory]="false">
              </generic-textarea>
            </div>

            <!-- DATE -->
            <div>
              <generic-date-picker *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_DATE"
                [(model)]="placeholder.value" [label]="placeholder.label" [form]="form"
                [propertyName]="placeholder.code + '_' + placeholder.id" [isMandatory]="false" [isDisabled]="false">
              </generic-date-picker>
            </div>

            <!-- INTEGER -->
            <div>
              <generic-input *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_INTEGER" [(model)]="placeholder.value"
                [label]="placeholder.label" [form]="form" [propertyName]="placeholder.code + '_' + placeholder.id"
                [isMandatory]="false" [isDisabled]="false" type="number">
              </generic-input>
            </div>

            <!-- SELECT -->
            <div>
              <select-value-service-field-type *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_SELECT"
                [(model)]="placeholder.value" [label]="placeholder.label" [form]="form"
                [propertyName]="placeholder.code + '_' + placeholder.id" [serviceFieldType]="placeholder"
                [isMandatory]="false" [isDisabled]="false">
              </select-value-service-field-type>
            </div>

            <!-- DEFAULT / UNKNOWN -->
            <div>
              <generic-input *ngIf="!placeholder.dataType" [model]="placeholder.value"
                [label]="placeholder.label ? placeholder.label : placeholder.code" [form]="form"
                [propertyName]="placeholder.code + '_' + placeholder.id" [isMandatory]="true" [isDisabled]="false"
                type="text">
              </generic-input>
            </div>
          </div>
        </div>

        <h4 class="mt-5 mb-3">Spécificités</h4>

        <!--============== FRAGMENT BLOCS ===============-->
        <div *ngFor="let selections of fragmentSelection; let i = index" class="my-4">

          <div style="border-radius: 4px; padding:1rem;" [ngClass]="{ 'selected-fragment': isFragmentSelected(selectedFragments[i]), 'fragment-border': !isFragmentSelected(selectedFragments[i])}
            ">

            <!-- Block title -->
            <div class="row align-items-center">
              <div class="col">
                <h6 class=" mb-0">
                  {{ selections.length > 0 ? getArrayInString(selections) : "Champs spécifiques : " + selections }}</h6>
              </div>
              <div class="col-auto">
                <button type="button"
                  (click)="changeToggleValue(selectedFragments[i] ? selectedFragments[i] : selections[0], i)"
                  class="btn btn-icon rounded-pill fs-xl"
                  [ngClass]="this.getSelectionClassForFragment(selectedFragments[i])">
                  <i class="ai-check"></i>
                </button>
              </div>

              <div class="col-12 mt-3" *ngIf="selections.length>1">
                <select-announcement-notice-template-fragment [types]="selections" [(model)]="selectedFragments[i]"
                  (modelChange)="onFragmentSelectionChange($event, i)" label="Selectionner" [form]="form"
                  [propertyName]="'select_'+selections[0].code"
                  [isMandatory]="false"></select-announcement-notice-template-fragment>
              </div>


            </div>

            <!-- Loop over placeholder entries -->
            <div *ngIf="selectedFragments[i]">
              <div class="my-4"
                *ngFor="let fragmentInstance of fragmentInstancesMap.get(selectedFragments[i]!.code); let fragmentIndex=index">

                <div
                  *ngIf="fragmentInstancesMap.get(selectedFragments[i]!.code)!.length>1 && fragmentIndex == fragmentInstancesMap.get(selectedFragments[i]!.code)!.length-1"
                  class="row justify-content-end px-3 ">
                  <button type="button" class="btn btn-sm btn-icon btn-outline-danger rounded-4 mt-n2"
                    aria-label="Delete" (click)="deleteFragmentInstance(selectedFragments[i]!.code)">
                    <i class="ai-trash"></i>
                  </button>
                </div>
                <div class="row row-cols-3 g-3" *ngIf="fragmentInstance">
                  <div class="col" *ngFor="let placeholder of placeholdersMap.get(fragmentInstance!.code)">

                    <!-- Wrap inputs automatically to next line -->
                    <div class="">

                      <!-- TEXT -->
                      <generic-input *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_TEXT"
                        [(model)]="placeholder.label"
                        [label]="getFragmentInputLabel(placeholder, fragmentIndex, fragmentInstancesMap.get(selectedFragments[i]!.code)!)"
                        [form]="form"
                        [propertyName]="buildFormControlName(fragmentInstance.code, placeholder, fragmentIndex)"
                        [isDisabled]="false" [isMandatory]="false" [maxLength]="255">
                      </generic-input>

                      <!-- TEXTAREA -->
                      <generic-textarea *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_TEXTAREA"
                        [ngClass]="{'w-100': placeholder.dataType === SERVICE_FIELD_TYPE_TEXTAREA}"
                        [(model)]="placeholder.value"
                        [label]="getFragmentInputLabel(placeholder, fragmentIndex, fragmentInstancesMap.get(selectedFragments[i]!.code)!)"
                        [form]="form"
                        [propertyName]="buildFormControlName(fragmentInstance.code, placeholder, fragmentIndex)"
                        [isDisabled]="false" [isMandatory]="false">
                      </generic-textarea>

                      <!-- DATE -->
                      <generic-date-picker *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_DATE"
                        [(model)]="placeholder.value"
                        [label]="getFragmentInputLabel(placeholder, fragmentIndex, fragmentInstancesMap.get(selectedFragments[i]!.code)!)"
                        [form]="form"
                        [propertyName]="buildFormControlName(fragmentInstance.code, placeholder, fragmentIndex)"
                        [isMandatory]="false" [isDisabled]="false">
                      </generic-date-picker>

                      <!-- INTEGER -->
                      <generic-input *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_INTEGER"
                        [(model)]="placeholder.value"
                        [label]="getFragmentInputLabel(placeholder, fragmentIndex, fragmentInstancesMap.get(selectedFragments[i]!.code)!)"
                        [form]="form"
                        [propertyName]="buildFormControlName(fragmentInstance.code, placeholder, fragmentIndex)"
                        [isDisabled]="false" type="number">
                      </generic-input>

                      <!-- SELECT -->
                      <select-value-service-field-type *ngIf="placeholder.dataType === SERVICE_FIELD_TYPE_SELECT"
                        [(model)]="placeholder.value"
                        [label]="getFragmentInputLabel(placeholder, fragmentIndex, fragmentInstancesMap.get(selectedFragments[i]!.code)!)"
                        [form]="form"
                        [propertyName]="buildFormControlName(fragmentInstance.code, placeholder, fragmentIndex)"
                        [isMandatory]="false" [isDisabled]="false">
                      </select-value-service-field-type>

                      <!-- DEFAULT / UNKNOWN -->
                      <generic-input *ngIf="!placeholder.dataType" [model]="placeholder.value"
                        (onFormFocus)="setSelectedFragment(fragmentInstance.code)"
                        [label]="getFragmentInputLabel(placeholder, fragmentIndex, fragmentInstancesMap.get(selectedFragments[i]!.code)!)"
                        [form]="form"
                        [propertyName]="buildFormControlName(fragmentInstance.code, placeholder, fragmentIndex)"
                        [isMandatory]="true" [isDisabled]="false" type="text">
                      </generic-input>

                    </div>
                  </div>
                </div>
                <hr
                  *ngIf="fragmentInstancesMap.get(selectedFragments[i]!.code)!.length>1 && fragmentIndex < fragmentInstancesMap.get(selectedFragments[i]!.code)!.length-1">
              </div>
              <div>
                <div *ngIf="selectedFragments[i] && selectedFragments[i]!.isMultiple"
                  class="row gap-2 justify-content-end m-0">
                  <a class="col fs-lg btn btn-primary" (click)="addFragmentInstance(selectedFragments[i]!.code)"><i
                      class="ai-circle-plus"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Preview section - 1/3 of width -->
    <div class="col-md-5 border-left px-4">
      <div class="sticky-top row" style="top: 4rem;">
        <div class="col">
          <h2 class="text-center">Annonce légale</h2>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-icon btn-secondary rounded-pill" (click)="showPreviewModal()">
            <i class="ai-search"></i>
          </button>
        </div>

        <div class="col-12 p-3 border rounded" style="max-height: 70vh; overflow-y: auto;">
          <div class="mb-0 text-wrap" [innerHTML]="displayText | trustHtml"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview modal -->
<ng-template #previewModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="confirmBackModalLabel">Prévisualisation de l'annonce légale</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Fermer"></button>
  </div>
  <div class="modal-body">
    <!-- Preview content -->
    <div *ngIf="getNoticeTemplateDescription()" class="p-3 border rounded"
      [innerHTML]="getNoticeTemplateDescription()!.displayText | trustHtml" style="white-space: pre-wrap;">
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Fermer</button>
  </div>
</ng-template>