<div class="d-flex align-items-center mb-4" *ngIf="order">
  <h1 class="h2 mb-0 me-3">Commande {{order.id}}</h1> <span class="badge bg-opacity-10   "
    [ngClass]="getClassForCustomerOrderStatus(order)">{{getCustomerOrderStatusLabel(order)}}</span>
</div>
<div class="alert alert-danger d-flex align-items-center mb-0 mb-2" role="alert"
  *ngIf="order && order.customerOrderStatus && order.customerOrderStatus.code == CUSTOMER_ORDER_STATUS_WAITING_DEPOSIT">
  <i class="ai-circle-info fs-xl"></i>
  <div class="ps-2">La commande ne pourra pas être traitée tant que l'acompte est impayé</div>
  <a class="btn btn-sm btn-secondary ms-auto" *ngIf="order && displayPayButton" (click)="payCustomerOrder($event)">
    <i class="ai-cart ms-n1 me-2"></i>
    <span>Payer l'acompte</span>
  </a>
</div>
<div class="alert alert-info d-flex mb-2" role="alert" *ngIf="associatedQuotation ">
  <i class="ai-circle-info fs-xl"></i>
  <div class="ps-2">Cette commande est issue du devis validé n°<a style="cursor: pointer; text-decoration: underline;"
      (click)="openQuotationDetails($event ,associatedQuotation);$event.stopPropagation();">{{associatedQuotation.id}}</a>
  </div>
</div>
<div class="d-flex align-items-center mb-4"
  *ngIf="order && ordersAssoAffaireOrders && ordersAssoAffaireOrders.length>1 && selectedAssoAffaireOrder">
  <div class="ms-auto">
    <div ngbDropdown class="btn-group dropdown" style="margin-right: 10px;">
      <button type="button" class="btn btn-secondary dropdown-toggle" ngbDropdownToggle aria-haspopup="true"
        aria-expanded="false">
        <i class="ai-briefcase me-2"></i>
        Affaire :
        {{capitalizeName(selectedAssoAffaireOrder.affaire.denomination?selectedAssoAffaireOrder.affaire.denomination:(selectedAssoAffaireOrder.affaire.firstname
        +"
        "+selectedAssoAffaireOrder.affaire.lastname))}}{{selectedAssoAffaireOrder.affaire.city?(" -
        "+capitalizeName(selectedAssoAffaireOrder.affaire.city.label)):""}}
      </button>
      <div ngbDropdownMenu class="dropdown-menu my-1">
        <label class=" dropdown-item" *ngFor="let asso of ordersAssoAffaireOrders">
          <a class="dropdown-item" style="cursor: pointer;" (click)="changeAffaire(asso) ">
            {{capitalizeName(asso.affaire.denomination?asso.affaire.denomination:(asso.affaire.firstname
            +"
            "+asso.affaire.lastname))}}{{asso.affaire.city?(" -
            "+capitalizeName(asso.affaire.city.label)):""}}
          </a>
        </label>
      </div>
    </div>
  </div>
</div>
<section class="card border-0 py-1 p-md-2 p-xl-3 p-xxl-4 mb-4" *ngIf="order && selectedAssoAffaireOrder">
  <div class="card-body">
    <div class="d-flex align-items-center mt-sm-n1 pb-4 mb-0 mb-lg-1 mb-xl-3">
      <i class="ai-briefcase text-primary lead pe-1 me-2"></i>
      <h2 class="h4 mb-0">
        Affaire :
        {{capitalizeName(selectedAssoAffaireOrder.affaire.denomination?selectedAssoAffaireOrder.affaire.denomination:(selectedAssoAffaireOrder.affaire.firstname
        +" "+selectedAssoAffaireOrder.affaire.lastname))}} </h2>
      <a class="btn btn-sm  ms-auto btn-danger" role="button"
        (click)="editAffaireDetails(selectedAssoAffaireOrder.affaire, $event)"
        *ngIf="(!selectedAssoAffaireOrder.affaire.paymentIban || !selectedAssoAffaireOrder.affaire.paymentBic || !selectedAssoAffaireOrder.affaire.mails || selectedAssoAffaireOrder.affaire.mails.length==0) && invoiceSummary && invoiceSummary.billingLabelType && invoiceSummary.billingLabelType.id == billingLabelTypeCodeAffaire.id ;else just_edit_affaire">
        <i class="ai-edit ms-n1 me-2"></i>
        Indiquer <span
          *ngIf="(!selectedAssoAffaireOrder.affaire.paymentIban || !selectedAssoAffaireOrder.affaire.paymentBic)">&nbsp;l'IBAN</span>
        <span
          *ngIf="(!selectedAssoAffaireOrder.affaire.paymentIban || !selectedAssoAffaireOrder.affaire.paymentBic) && (!selectedAssoAffaireOrder.affaire.mails || selectedAssoAffaireOrder.affaire.mails.length==0)">&nbsp;et</span>
        <span
          *ngIf="(!selectedAssoAffaireOrder.affaire.mails || selectedAssoAffaireOrder.affaire.mails.length==0)">&nbsp;le
          mail</span>
      </a>
      <ng-template #just_edit_affaire> <a class="btn btn-sm  ms-auto btn-secondary" role="button"
          (click)="editAffaireDetails(selectedAssoAffaireOrder.affaire, $event)">
          <i class="ai-edit ms-n1 me-2"></i>
          Modifier
        </a></ng-template>
    </div>
    <div class="d-flex align-items-center pb-1 mb-2">
      <h3 class="h6 mb-0 me-3" *ngIf="selectedAssoAffaireOrder.affaire.siret">
        {{selectedAssoAffaireOrder.affaire.legalForm?selectedAssoAffaireOrder.affaire.legalForm.label:""}} -
        {{selectedAssoAffaireOrder.affaire.siret }}</h3>
      <h3 class="h6 mb-0 me-3" *ngIf="!selectedAssoAffaireOrder.affaire.siret">
        Société non enregistrée
      </h3>
    </div>
    <p class="mb-0">{{selectedAssoAffaireOrder.affaire.address}}<br>{{selectedAssoAffaireOrder.affaire.postalCode}}
      {{selectedAssoAffaireOrder.affaire.city?selectedAssoAffaireOrder.affaire.city.label:""}}<br></p>
    <p class="mb-0 mt-1" *ngIf="selectedAssoAffaireOrder.affaire.competentAuthority">
      RCS : {{capitalizeName(selectedAssoAffaireOrder.affaire.competentAuthority.label)}}</p>
    <div class="d-flex align-items-center me-3 mt-2"
      *ngIf="selectedAssoAffaireOrder.affaire.mails && selectedAssoAffaireOrder.affaire.mails.length>0">
      <i class="ai-mail me-1"></i>
      {{getListMails(selectedAssoAffaireOrder.affaire.mails)}}
    </div>
    <div class="d-flex align-items-center me-3"
      *ngIf="selectedAssoAffaireOrder.affaire.phones && selectedAssoAffaireOrder.affaire.phones.length>0">
      <i class="ai-phone me-1"></i>
      {{getListPhones(selectedAssoAffaireOrder.affaire.phones)}}
    </div>
    <div class="d-flex align-items-center me-3 mt-2" *ngIf="selectedAssoAffaireOrder.affaire.paymentIban">
      <i class="ai-wallet me-1"></i>
      {{selectedAssoAffaireOrder.affaire.paymentIban}} / {{selectedAssoAffaireOrder.affaire.paymentBic}}
    </div>
  </div>

</section>
<section class="card border-0 py-1 p-md-2 p-xl-3 p-xxl-4 mb-4" *ngIf="order && selectedAssoAffaireOrder">
  <div class="card-body">
    <div class="d-flex align-items-center mt-sm-n1 mb-0">
      <i class="ai-layer text-primary lead pe-1 me-2"></i>
      <h2 class="h4 mb-0">Services commandés</h2>
    </div>
  </div>
  <div ngbAccordion [closeOthers]="true" *ngIf="selectedAssoAffaireOrder.services">
    <div ngbAccordionItem *ngFor="let service of selectedAssoAffaireOrder.services; let index =index"
      (show)="loadServiceDetails(service,false)">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton class="border-top">
          <div class="d-flex justify-content-between w-100">
            <div class="ps-3 ps-sm-4">
              <h4 class="h6 mb-2">
                <a>{{service.serviceLabelToDisplay}}</a>
              </h4>
              <div class="text-body-secondary fs-sm me-3">
                <span class="badge bg-info bg-opacity-10 text-info fs-xs">{{service.serviceStatus}}</span>
              </div>
            </div>
            <div class="me-3 me-sm-4" *ngIf="service.confrereLabel">
              <div class="fs-sm text-body-secondary">{{service.confrereLabel}}</div>
              <!-- TODO : ajouter le lien vers le SPEL jss ou autre-->
            </div>
            <div class="me-3 me-sm-4"
              *ngIf="serviceProvisionAttachments[service.id] && serviceProvisionAttachments[service.id].length>0">
              <div class="fs-sm text-body-secondary">{{serviceProvisionAttachments[service.id].length}}
                document{{serviceProvisionAttachments[service.id].length>1?'s':''}}
                disponible{{serviceProvisionAttachments[service.id].length>1?'s':''}}</div>
            </div>
            <div class="me-3 me-sm-4">
              <div class="text-body-secondary fs-sm me-3 ">
                {{service.serviceTotalPrice | currency:'EUR' }}
              </div>
            </div>
            <div class="me-3 me-sm-4">
              <div class="fs-sm fw-medium text-dark">
                <i class="ai-triangle-alert fs-base text-danger ms-2" style="-webkit-text-stroke: 1px;"
                  placement="right" *ngIf="service.hasMissingInformations"
                  [ngbTooltip]="'Le '+getLastMissingAttachmentQueryDateLabel(service)+' : des renseignements complémentaires sont nécessaires : veuillez vous reporter au détail du service'"></i>
              </div>
            </div>
          </div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <ul ngbNav #nav="ngbNav" [activeId]="1" class="nav-tabs">
              <li [ngbNavItem]="1">
                <button ngbNavLink>Mes documents</button>
                <ng-template ngbNavContent>
                  <div class="alert alert-info d-flex mb-0 mb-2" role="alert">
                    <i class="ai-circle-info fs-xl"></i>
                    <div class="ps-2">Vous pouvez télécharger ci-dessous les documents nécessaires au traitement du
                      service</div>
                  </div>
                  <div class="list-group">
                    <ng-container *ngFor="let assoServiceDocument of service.assoServiceDocuments;let index = index">
                      <div class="list-group-item list-group-item-action flex-column align-items-start py-3 "
                        [ngClass]="{'border-top-1':index>0}" style="border-width: 2px;"
                        *ngIf="assoServiceDocument.isMandatory">
                        <div class="d-flex flex-wrap w-100 justify-content-between">
                          <h6>{{assoServiceDocument.typeDocument.customLabel}}</h6>
                        </div>
                        <p class="fs-sm  "
                          *ngIf="assoServiceDocument.formalisteComment && assoServiceDocument.formalisteComment.length>0">
                          {{assoServiceDocument.formalisteComment}}</p>
                        <div class="mb-2 mb-md-3 row  ">
                          <div class="col-md-12">
                            <single-upload [entity]="assoServiceDocument"
                              (endOfUpload)="refreshCurrentAssoAffaireOrder()"
                              [entityType]="ASSO_SERVICE_DOCUMENT_ENTITY_TYPE.entityType" [isDirectUpload]="true"
                              [attachmentType]="assoServiceDocument.typeDocument.attachmentType"
                              [typeDocument]="assoServiceDocument.typeDocument"></single-upload>
                          </div>
                        </div>
                        <div class="table-responsive"
                          *ngIf="assoServiceDocument.attachments && assoServiceDocument.attachments.length>0">
                          <table class="table table-hover mb-0">
                            <thead>
                              <tr>
                                <th style="width: 5%;">#</th>
                                <th>Nom</th>
                                <th class="d-none d-md-table-cell" style="width: 20%;">Type</th>
                                <th class="d-none d-lg-table-cell" style="width: 20%;">Date de dépôt</th>
                                <th style="width: 10%;"></th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let attachment of assoServiceDocument.attachments; let i = index">
                                <th scope="row">{{i + 1}}</th>
                                <td class="text-wrap" style="min-width: 150px;">{{attachment.description}}</td>
                                <td class="d-none d-md-table-cell">{{attachment.attachmentType.label}}</td>
                                <td class="d-none d-lg-table-cell">{{attachment.creatDateTime | date:'dd/MM/yyyy'}}</td>
                                <td>
                                  <button type="button" class="btn btn-secondary btn-icon btn-sm"
                                    aria-label="Télécharger" placement="right" ngbTooltip="Télécharger"
                                    (click)="downloadAttachment(attachment)">
                                    <i class="ai-download"></i>
                                  </button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </ng-template>
              </li>
              <li [ngbNavItem]="2" *ngIf=" service.assoServiceFieldTypes && service.assoServiceFieldTypes.length>0">
                <button ngbNavLink>Mes informations complémentaires</button>
                <ng-template ngbNavContent>
                  <div class="alert alert-info d-flex mb-2" role="alert">
                    <i class="ai-circle-info fs-xl"></i>
                    <div class="ps-2">Vous pouvez renseigner ci-dessous les informations complémentaires nécessaires au
                      traitement du service</div>
                  </div>
                  <div *ngFor="let assoServiceFieldType of service.assoServiceFieldTypes; let i = index">
                    <div class="mb-3" *ngIf="assoServiceFieldType.serviceFieldType.dataType==SERVICE_FIELD_TYPE_TEXT">
                      <label for="text-input" class="form-label">{{assoServiceFieldType.serviceFieldType.label}}</label>
                      <div> <input class="form-control" id="text-input" [(ngModel)]="assoServiceFieldType.stringValue"
                          maxLength="255" />
                      </div>
                    </div>
                    <div class="mb-3"
                      *ngIf="assoServiceFieldType.serviceFieldType.dataType==SERVICE_FIELD_TYPE_TEXTAREA">
                      <label for="text-textarea"
                        class="form-label">{{assoServiceFieldType.serviceFieldType.label}}</label>
                      <div> <textarea class="form-control" id="text-textarea"
                          [(ngModel)]="assoServiceFieldType.textAreaValue" rows="5"></textarea>
                      </div>
                    </div>
                    <div class="mb-3" *ngIf="assoServiceFieldType.serviceFieldType.dataType==SERVICE_FIELD_TYPE_DATE">
                      <label for="text-date" class="form-label">{{assoServiceFieldType.serviceFieldType.label}}</label>
                      <div> <input class="form-control" id="text-date" type="date"
                          [(ngModel)]="assoServiceFieldType.dateValue" />
                      </div>
                    </div>
                    <div class="mb-3"
                      *ngIf="assoServiceFieldType.serviceFieldType.dataType==SERVICE_FIELD_TYPE_INTEGER">
                      <label for="text-integer"
                        class="form-label">{{assoServiceFieldType.serviceFieldType.label}}</label>
                      <div> <input class="form-control" id="integer" type="number"
                          [(ngModel)]="assoServiceFieldType.integerValue" />
                      </div>
                    </div>
                    <div class="mb-3" *ngIf="assoServiceFieldType.serviceFieldType.dataType==SERVICE_FIELD_TYPE_SELECT">
                      <label for="text-select"
                        class="form-label">{{assoServiceFieldType.serviceFieldType.label}}</label>
                      <div>
                        <select id="text-select" class="form-select form-select-lg"
                          [(ngModel)]="assoServiceFieldType.selectValue">
                          <option
                            *ngFor="let option of assoServiceFieldType.serviceFieldType.serviceFieldTypePossibleValues"
                            [value]="option">
                            {{option.value}}</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="text-center pt-1 pt-sm-2">
                    <div class="btn-group   " role="group" aria-label="Outline button group">
                      <button type="button" class="btn btn-primary"
                        (click)="saveFieldsValue(service)">Enregistrer</button>
                    </div>
                  </div>
                </ng-template>
              </li>
              <li [ngbNavItem]="3" *ngIf=" service.assoServiceFieldTypes && service.assoServiceFieldTypes.length>0">
                <button ngbNavLink>Documents disponibles <span class="badge bg-success"
                    style="margin-left: 10px;"></span></button>
                <ng-template ngbNavContent>
                  <div class="table-responsive"
                    *ngIf="serviceProvisionAttachments[service.id] && serviceProvisionAttachments[service.id].length>0">
                    <table class="table table-hover mb-0">
                      <thead>
                        <tr>
                          <th style="width: 5%;">#</th>
                          <th>Nom</th>
                          <th class="d-none d-md-table-cell" style="width: 20%;">Type</th>
                          <th class="d-none d-lg-table-cell" style="width: 20%;">Date de dépôt</th>
                          <th style="width: 10%;"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let attachment of serviceProvisionAttachments[service.id]; let i = index">
                          <th scope="row">{{i + 1}}</th>
                          <td class="text-wrap" style="min-width: 150px;">{{attachment.description}}</td>
                          <td class="d-none d-md-table-cell">{{attachment.attachmentType.label}}</td>
                          <td class="d-none d-lg-table-cell">{{attachment.creatDateTime | date:'dd/MM/yyyy'}}</td>
                          <td>
                            <button type="button" class="btn btn-secondary btn-icon btn-sm" aria-label="Télécharger"
                              placement="right" ngbTooltip="Télécharger" (click)="downloadAttachment(attachment)">
                              <i class="ai-download"></i>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </ng-template>
              </li>
            </ul>
            <div [ngbNavOutlet]="nav" class="mt-2"></div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
  <!-- Address -->
  <section class="col">
    <div class="card h-100 border-0 py-1 p-md-2 p-xl-3 p-xxl-4">
      <div class="card-body">
        <div class="d-flex align-items-center mt-sm-n1 pb-4 mb-1 mb-lg-2">
          <i class="ai-map-pin text-primary lead pe-1 me-2"></i>
          <h2 class="h4 mb-0">Adresses</h2>
          <a class="btn btn-sm btn-secondary ms-auto" (click)="editAddress($event)">
            <i class="ai-edit ms-n1 me-2"></i>
            Modifier
          </a>
        </div>
        <div class="d-flex align-items-center pb-1 mb-2">
          <h3 class="h6 mb-0 me-3">Adresse de facturation</h3>
        </div>
        <div class="text-body-secondary fw-medium d-flex flex-wrap flex-sm-nowrap align-items-center my-1"
          *ngIf="orderMailComputeResult">
          <div class="d-flex align-items-center me-3">
            <i class="ai-mail me-1"></i>
            {{getCustomerOrderBillingMailList()}}
          </div>
        </div>
        <p class="mb-0" *ngIf="orderInvoiceLabelResult">
          {{orderInvoiceLabelResult.billingLabel}}<br>{{orderInvoiceLabelResult.billingLabelAddress
          }}<br>{{orderInvoiceLabelResult.billingLabelPostalCode }}
          {{orderInvoiceLabelResult.billingLabelCity?orderInvoiceLabelResult.billingLabelCity.label:""}}<span
            *ngIf="orderInvoiceLabelResult.commandNumber && orderInvoiceLabelResult.commandNumber.length>0"><br>Commande
            {{orderInvoiceLabelResult.commandNumber }}</span></p>
        <div class="col-sm-7 col-md-5 mb-4 mb-md-0" *ngIf="!orderInvoiceLabelResult">
          <p class="card-text placeholder-glow">
            <span class="placeholder placeholder-sm col-7 me-2"></span>
            <span class="placeholder placeholder-sm col-4"></span>
            <span class="placeholder placeholder-sm col-4"></span>
          </p>
        </div>
        <div class="d-flex align-items-center pt-4 pb-1 my-2">
          <h3 class="h6 mb-0 me-3">Adresse d'envoi des documents</h3>
        </div>
        <div class="text-body-secondary fw-medium d-flex flex-wrap flex-sm-nowrap align-iteems-center my-1"
          *ngIf="digitalMailComputeResult">
          <div class="d-flex align-items-center me-3">
            <i class="ai-mail me-1"></i>
            {{getCustomerOrderDigitalMailList()}}
          </div>
        </div>
        <div class="col-sm-7 col-md-5 mb-4 mb-md-0" *ngIf="!orderPhysicalMailComputeResult">
          <p class="card-text placeholder-glow">
            <span class="placeholder placeholder-sm col-7 me-2"></span>
          </p>
        </div>
        <p class="mb-0" *ngIf="orderPhysicalMailComputeResult">
          {{orderPhysicalMailComputeResult.billingLabel}}<br>{{orderPhysicalMailComputeResult.billingLabelAddress
          }}<br>{{orderPhysicalMailComputeResult.billingLabelPostalCode }}
          {{orderPhysicalMailComputeResult.billingLabelCity?orderPhysicalMailComputeResult.billingLabelCity.label:""}}<span
            *ngIf="orderPhysicalMailComputeResult.commandNumber && orderPhysicalMailComputeResult.commandNumber.length>0"><br>Commande
            {{orderPhysicalMailComputeResult.commandNumber }}</span></p>
        <div class="col-sm-7 col-md-5 mb-4 mb-md-0" *ngIf="!orderPhysicalMailComputeResult">
          <p class="card-text placeholder-glow">
            <span class="placeholder placeholder-sm col-7 me-2"></span>
            <span class="placeholder placeholder-sm col-4"></span>
            <span class="placeholder placeholder-sm col-4"></span>
          </p>
        </div>
      </div>
    </div>
  </section>


  <!-- Billing -->
  <section class="col">
    <div class="card h-100 border-0 py-1 p-md-2 p-xl-3 p-xxl-4">
      <div class="card-body">
        <div class="d-flex align-items-center mt-sm-n1 pb-4 mb-1 mb-lg-2">
          <i class="ai-wallet text-primary lead pe-1 me-2"></i>
          <h2 class="h4 mb-0">Facturation</h2>
          <a class="btn btn-sm btn-secondary ms-auto" *ngIf="order && invoiceSummary && displayPayButton"
            (click)="payCustomerOrder($event)">
            <i class="ai-cart ms-n1 me-2"></i>
            <span *ngIf="order.customerOrderStatus.code==CUSTOMER_ORDER_STATUS_BILLED">Payer le solde</span>
            <span *ngIf="order.customerOrderStatus.code!=CUSTOMER_ORDER_STATUS_BILLED">Payer un acompte</span>
          </a>
        </div>
        <div class="d-flex align-items-center pb-1 mb-2" *ngIf="orderPayments && orderPayments.length>0">
          <h3 class="h6 mb-0 me-3">Paiements reçus</h3>
        </div>
        <ng-container *ngIf="orderPayments && orderPayments.length>0">
          <div class="d-flex align-items-center mb-1 mb-sm-3" *ngFor="let payment of orderPayments">
            <svg width="52" height="42" viewBox="0 0 52 42" fill="none" xmlns="http://www.w3.org/2000/svg"
              *ngIf="payment.paymentType.id == paymentTypeCb.id" placement="right"
              ngbTooltip="Paiement par carte bleue">
              <path
                d="M22.6402 28.2865H18.5199L21.095 12.7244H25.2157L22.6402 28.2865ZM15.0536 12.7244L11.1255 23.4281L10.6607 21.1232L10.6611 21.124L9.27467 14.1256C9.27467 14.1256 9.10703 12.7244 7.32014 12.7244H0.8262L0.75 12.9879C0.75 12.9879 2.73586 13.3942 5.05996 14.7666L8.63967 28.2869H12.9327L19.488 12.7244H15.0536ZM47.4619 28.2865H51.2453L47.9466 12.7239H44.6345C43.105 12.7239 42.7324 13.8837 42.7324 13.8837L36.5873 28.2865H40.8825L41.7414 25.9749H46.9793L47.4619 28.2865ZM42.928 22.7817L45.093 16.9579L46.3109 22.7817H42.928ZM36.9095 16.4667L37.4975 13.1248C37.4975 13.1248 35.6831 12.4463 33.7916 12.4463C31.7469 12.4463 26.8913 13.3251 26.8913 17.5982C26.8913 21.6186 32.5902 21.6685 32.5902 23.7803C32.5902 25.8921 27.4785 25.5137 25.7915 24.182L25.1789 27.6763C25.1789 27.6763 27.0187 28.555 29.8296 28.555C32.6414 28.555 36.8832 27.1234 36.8832 23.2271C36.8832 19.1808 31.1331 18.8041 31.1331 17.0449C31.1335 15.2853 35.1463 15.5113 36.9095 16.4667Z"
                fill="#2566AF" />
              <path
                d="M10.6611 22.1235L9.2747 15.1251C9.2747 15.1251 9.10705 13.7239 7.32016 13.7239H0.8262L0.75 13.9874C0.75 13.9874 3.87125 14.6235 6.86507 17.0066C9.72766 19.2845 10.6611 22.1235 10.6611 22.1235Z"
                fill="#E6A540" />
            </svg>
            <ng-container *ngIf="!payment.refund">
              <i *ngIf="payment.paymentType.id != paymentTypeCb.id" class="ai-edit ms-n1 me-2" placement="right"
                [ngbTooltip]="'Paiement par '+payment.paymentType.label.toLowerCase()"></i>
              <div class="ps-3 fs-sm">
                <div class="text-dark">{{payment.paymentAmount | currency:'EUR' }} - <span placement="right"
                    [ngbTooltip]="payment.label">{{payment.label.substring(0,25)}}</span>
                </div>
                <div class="text-body-secondary">le {{payment.paymentDate| date:'dd/MM/yyyy'}}</div>
              </div>
            </ng-container>
            <ng-container *ngIf="payment.refund">
              <i *ngIf="payment.paymentType.id != paymentTypeCb.id" class="ai-edit ms-n1 me-2" placement="right"
                ngbTooltip="Remboursement par virement bancaire"></i>
              <div class="ps-3 fs-sm">
                <div class="text-dark">{{payment.paymentAmount | currency:'EUR' }} - Remboursement <span
                    placement="right" [ngbTooltip]="payment.label">{{payment.label.substring(0,15)}}</span>
                </div>
                <div class="text-body-secondary">Effectué le {{payment.paymentDate| date:'dd/MM/yyyy'}}</div>
              </div>
            </ng-container>
          </div>
        </ng-container>
        <div class="d-flex align-items-center pt-2 pb-1 mb-2">
          <h3 class="h6 mb-0 me-3">Montant <span
              *ngIf="order && order.customerOrderStatus.code !=CUSTOMER_ORDER_STATUS_BILLED">prévisionnel</span></h3>
        </div>
        <div class="col-sm-7 col-md-5 mb-4 mb-md-0" *ngIf="!invoiceSummary">
          <p class="card-text placeholder-glow">
            <span class="placeholder placeholder-sm col-7 me-2"></span>
            <span class="placeholder placeholder-sm col-4"></span>
            <span class="placeholder placeholder-sm col-4"></span>
            <span class="placeholder placeholder-sm col-4"></span>
            <span class="placeholder placeholder-sm col-4"></span>
          </p>
        </div>
        <div class="  mt-4" *ngIf="invoiceSummary">
          <div class="d-flex align-items-center fs-sm text-dark pb-1 mb-2">
            <span class="ms-2">Prix HT</span>
            <span class="ms-auto">{{invoiceSummary.preTaxPriceTotal | currency:'EUR' }}</span>
          </div>
          <div class="d-flex align-items-center fs-sm text-dark pb-1 mb-2">
            <span class="ms-2">TVA</span>
            <span class="ms-auto">{{invoiceSummary.vatTotal| currency:'EUR' }}</span>
          </div>
          <div class="d-flex align-items-center fs-sm text-dark pb-1 mb-2"
            *ngIf="invoiceSummary.discountTotal && invoiceSummary.discountTotal>0">
            <span class="ms-2">Remise</span>
            <span class="ms-auto">{{invoiceSummary.discountTotal| currency:'EUR' }}</span>
          </div>
          <div class="d-flex align-items-center fs-sm text-dark pb-1 mb-2">
            <span class="ms-2">
              <h6>Total TTC</h6>
            </span>
            <span class="ms-auto">
              <h6>{{invoiceSummary.totalPrice| currency:'EUR' }}</h6>
            </span>
          </div>
        </div>
        <div class="text-center pt-1 pt-sm-2">
          <a class="btn btn-sm btn-secondary ms-auto"
            *ngIf="order && order.customerOrderStatus.code ==CUSTOMER_ORDER_STATUS_BILLED" (click)="downloadInvoice()">
            <i class="ai-cart ms-n1 me-2"></i>
            <span>Télécharger la facture</span>
          </a>
        </div>
      </div>
    </div>
  </section>
</div>
<section class="card border-0  " *ngIf="order">
  <div class="card-body">
    <div class="d-flex align-items-center mt-sm-n1 mb-0">
      <i class="ai-message text-primary lead pe-1 me-2"></i>
      <h2 class="h4 mb-0">Echangez avec notre équipe</h2>
    </div>
    <div class="simplebar-mask">
      <div class="simplebar-offset" style="right: 0px; bottom: 0px;">
        <div class="simplebar-content-wrapper" tabindex="0" role="region" style="height: auto;  ">
          <div class="simplebar-content" style="padding: 24px 38px 0px;">
            <!-- Message -->
            <div class="ms-auto mb-3" style="max-width: 392px;"
              *ngIf="!customerOrderComments || customerOrderComments.length==0">
              <div class="d-flex align-items-end mb-2">
                <div class="message-box-end bg-primary text-white"><span class="break-line">Posez votre question
                    ci-dessous !</span></div>
                <div class="flex-shrink-0 ps-2 ms-1">
                  <avatar class="avatar-select" [user]="jssEmployee" [size]="40" placement="right"
                    [ngbTooltip]="jssEmployee.firstname + ' '+jssEmployee.lastname  ">
                  </avatar>
                </div>
              </div>
              <div class="fs-xs text-body-secondary"> {{currentDate|date:'dd/MM/yyyy
                HH:mm'}}
              </div>
            </div>
            <ng-container *ngFor="let comment of customerOrderComments">
              <div class="mb-3" style="max-width: 392px;" *ngIf="comment.currentCustomer">
                <div class="d-flex align-items-end mb-2">
                  <div class="flex-shrink-0 pe-2 me-1">
                    <avatar class="avatar-select" [user]="comment.currentCustomer" [size]="40"></avatar>
                  </div>
                  <div class="message-box-start text-dark"><span class="break-line"
                      [innerHTML]="comment.comment | trustHtml"></span></div>
                </div>
                <div class="fs-xs text-body-secondary text-end"> {{comment.createdDateTime|date:'dd/MM/yyyy HH:mm'}} <i
                    class="ai-edit " style="cursor: pointer;"
                    *ngIf="comment.currentCustomer && currentUser &&  comment.currentCustomer.id == currentUser.id"
                    placement="right" ngbTooltip="Modifier le commentaire"
                    (click)="editCustomerOrderComment(comment)"></i>
                </div>
              </div>

              <!-- Message -->
              <div class="ms-auto mb-3" style="max-width: 392px;" *ngIf="comment.employee">
                <div class="d-flex align-items-end mb-2">
                  <div class="message-box-end bg-primary text-white break-line"><span
                      [innerHTML]="comment.comment | trustHtml"></span> </div>
                  <div class="flex-shrink-0 ps-2 ms-1">
                    <avatar class="avatar-select" [user]="comment.employee" [size]="40" placement="right"
                      [ngbTooltip]="comment.employee.firstname + ' '+comment.employee.lastname +' - '+comment.employee.title ">
                    </avatar>
                  </div>
                </div>
                <div class="fs-xs text-body-secondary"> {{comment.createdDateTime|date:'dd/MM/yyyy
                  HH:mm'}}
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card-footer w-100 border-0 mx-0 px-4">
    <div class="d-flex align-items-end border rounded-3 pb-3 pe-3 mx-sm-3">
      <textarea [(ngModel)]="newCustomerOrderComment.comment" class="form-control border-0" rows="3"
        placeholder="Ecrivez un message" style="resize: none;"></textarea>
      <div class="nav flex-nowrap align-items-center">
        <button class="btn btn-sm btn-secondary ms-3" type="button" (click)="addCustomerOrderComment()">Envoyer</button>
      </div>
    </div>
  </div>
</section>
